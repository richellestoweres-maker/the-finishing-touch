<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contractor Portal – The Finishing Touch</title>

  <!-- Fonts + Site CSS (same look/feel) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body{background:#fbf8f4}
    .app { width:min(1100px,94%); margin:22px auto 60px; }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      background:#fff; border-radius:14px; padding:12px 16px; box-shadow:var(--shadow,0 10px 30px rgba(0,0,0,.08));
      margin-bottom:16px;
    }
    .brand-mini{display:flex; align-items:center; gap:.6rem;}
    .brand-mini .vase{ width:28px; height:36px; background:url('logo-vase.png') center/contain no-repeat; }
    .brand-mini .name{ font-family:"Playfair Display",serif; font-weight:700; color:var(--taupe-900,#2e2a27); }
    .role-chip{
      font-weight:800; font-size:.78rem; padding:.28rem .6rem; border-radius:999px; border:1px solid #e3d9ce; color:#7b746e; background:#fffdfb;
    }
    .tabs { display:flex; gap:8px; }
    .tab-btn{ border:1px solid #e3d9ce; background:#fff; color:#2e2a27; font-weight:800; padding:.55rem .9rem; border-radius:999px; cursor:pointer; }
    .tab-btn.active{ background:#2e2a27; color:#fff; border-color:#2e2a27; }

    .signout-btn{
      border:1.5px solid #2e2a27; color:#2e2a27; background:#fff; border-radius:999px; padding:.5rem .8rem; font-weight:800; cursor:pointer;
    }

    /* Filters */
    .filters{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px; }
    .chip{ border:1px solid #e3d9ce; background:#fff; color:#2e2a27; border-radius:999px; padding:.4rem .7rem; cursor:pointer; font-weight:700; }
    .chip.active{ background:#f6f2ed; }

    /* Lists */
    .lists{ background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:18px; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; }
    .card{
      border:1px solid #e8ddd1; border-radius:14px; padding:12px; background:#fffdfb;
      display:flex; flex-direction:column; gap:8px;
    }
    .card h4{ margin:0; font-family:"Playfair Display",serif; }
    .mini{ font-size:.9rem; opacity:.9; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .btn{ display:inline-block; padding:.55rem .85rem; border-radius:10px; font-weight:800; cursor:pointer; text-decoration:none; }
    .btn-claim{ background:#2e2a27; color:#fff; border:0; }
    .btn-outline{ border:1px solid #2e2a27; color:#2e2a27; background:#fff; }
    .muted{ color:#7b746e; }
    .warn{ color:#b00020; font-weight:800; }
    .ok{ color:#0a7d33; font-weight:800; }

    .empty{ text-align:center; padding:30px 12px; color:#7b746e; }

    /* Address reveal info */
    .addr{ font-weight:700; }
    .addr.locked{ filter: blur(3px); }

    /* Footer note */
    .foot-note{ text-align:center; margin-top:14px; font-size:.92rem; color:#7b746e; }

    /* Hide on inactive tab */
    [data-panel]{ display:none; }
    [data-panel].show{ display:block; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand-mini">
        <span class="vase" aria-hidden="true"></span>
        <span class="name">The Finishing Touch</span>
        <span id="roleChip" class="role-chip" title="Your access level">…</span>
      </div>
      <div class="tabs">
        <button id="tabOpen" class="tab-btn active">Open Jobs</button>
        <button id="tabMine" class="tab-btn">My Jobs</button>
      </div>
      <button id="signOutBtn" class="signout-btn">Sign out</button>
    </div>

    <!-- Filters (only affect Open Jobs) -->
    <div id="filters" class="filters" aria-label="Filter by service type"></div>

    <!-- Content panels -->
    <div class="lists">
      <div id="panelOpen" data-panel class="show">
        <div id="openList" class="grid"></div>
        <div id="openEmpty" class="empty" hidden>No open jobs match your filters.</div>
      </div>
      <div id="panelMine" data-panel>
        <div id="myList" class="grid"></div>
        <div id="myEmpty" class="empty" hidden>No jobs yet. Claim one from the Open Jobs tab.</div>
      </div>
    </div>

    <p class="foot-note">
      You’ll see <strong>city + ZIP</strong> on Open Jobs. After you claim a job, the full address appears here in <em>My Jobs</em>.
    </p>

    <p id="errorMsg" class="foot-note warn" hidden></p>
  </div>

  <!-- Firebase + App code -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import {
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      collection, doc, getDoc, getDocs, setDoc, updateDoc, serverTimestamp,
      query, where, onSnapshot, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // --- UI refs
    const roleChip = document.getElementById('roleChip');
    const filtersWrap = document.getElementById('filters');
    const openList = document.getElementById('openList');
    const myList = document.getElementById('myList');
    const openEmpty = document.getElementById('openEmpty');
    const myEmpty = document.getElementById('myEmpty');
    const errEl = document.getElementById('errorMsg');

    // Tabs
    const tabOpen = document.getElementById('tabOpen');
    const tabMine = document.getElementById('tabMine');
    const panelOpen = document.getElementById('panelOpen');
    const panelMine = document.getElementById('panelMine');

    tabOpen.addEventListener('click', ()=>{
      tabOpen.classList.add('active'); tabMine.classList.remove('active');
      panelOpen.classList.add('show'); panelMine.classList.remove('show');
    });
    tabMine.addEventListener('click', ()=>{
      tabMine.classList.add('active'); tabOpen.classList.remove('active');
      panelMine.classList.add('show'); panelOpen.classList.remove('show');
    });

    // App state
    let me = null;            // auth user
    let meProfile = null;     // Firestore user profile
    let allowed = ['cleaning','organizing','decor','holiday']; // default if profile missing
    let filterSet = new Set(); // active filters

    // Build filter chips from allowed services
    function buildFilters(){
      filtersWrap.innerHTML = '';
      const pretty = {cleaning:'Cleaning', organizing:'Organizing', decor:'Decor', holiday:'Holiday'};
      allowed.forEach(key=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'chip';
        b.textContent = pretty[key] || key;
        b.dataset.key = key;
        b.addEventListener('click', ()=>{
          if (filterSet.has(key)) filterSet.delete(key); else filterSet.add(key);
          b.classList.toggle('active');
          renderOpenJobs(); // re-filter client-side
        });
        filtersWrap.appendChild(b);
      });
    }

    // Helpers
    const fmtUSD = n => (typeof n === 'number') ? `$${n.toLocaleString()}` : '';
    const contractorShare = (flat, pct=0.70) => Math.round((Number(flat)||0) * pct);

    function cardOpen(job){
      const $ = (k) => job?.[k];
      const zip = $('zip') || '';
      const area = $('area') || '';
      const when = $('window') || '';
      const service = $('serviceType') || '—';
      const flat = Number($('flatRate')||0);
      const share = contractorShare(flat);

      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <h4>${service}</h4>
        <div class="mini">${area ? area : ''}${zip ? (area? ' · ' : '') + zip : ''}${when ? ' · ' + when : ''}</div>
        <div class="mini">${$('summary')||''}</div>
        <div class="row">
          <div>
            <div><strong>${fmtUSD(flat)}</strong> flat</div>
            <div class="mini muted">Your pay est: <strong>${fmtUSD(share)}</strong></div>
          </div>
          <button class="btn btn-claim">Claim</button>
        </div>
      `;
      div.querySelector('.btn-claim').addEventListener('click', ()=> claimJob(job.id));
      return div;
    }

    function cardMine(job){
      const $ = (k) => job?.[k];
      const service = $('serviceType') || '—';
      const status = $('status') || 'claimed';
      const flat = Number($('flatRate')||0);
      const share = contractorShare(flat);
      const area = $('area') || '';
      const zip = $('zip') || '';
      const when = $('window') || '';
      const summary = $('summary') || '';

      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <h4>${service}</h4>
        <div class="mini">Status: <strong>${status}</strong></div>
        <div class="mini">${area ? area : ''}${zip ? (area? ' · ' : '') + zip : ''}${when ? ' · ' + when : ''}</div>
        <div class="mini">${summary}</div>

        <div class="mini muted">Payout est: <strong>${fmtUSD(share)}</strong></div>

        <div class="mini" id="addr-${job.id}">
          <span class="muted">Address:</span> <span class="addr locked">Hidden</span>
        </div>

        <div class="row">
          <button class="btn btn-outline" data-act="progress">Mark In Progress</button>
          <button class="btn btn-claim" data-act="submit">Submit for Approval</button>
        </div>
      `;

      div.querySelector('[data-act="progress"]').addEventListener('click', ()=> updateStatus(job.id,'in-progress'));
      div.querySelector('[data-act="submit"]').addEventListener('click', ()=> updateStatus(job.id,'submitted'));

      // Try to reveal the full address from private doc
      revealAddress(job.id);

      return div;
    }

    async function revealAddress(jobId){
      // Reads jobs/{jobId}/private/pii (address/name/phone/email) – rules should only allow claimer (or admin).
      try{
        const piiRef = doc(db, `jobs/${jobId}/private/pii`);
        const snap = await getDoc(piiRef);
        const el = document.getElementById(`addr-${jobId}`);
        if (!el) return;
        if (snap.exists()){
          const data = snap.data();
          const addr = data?.address || '(no address set yet)';
          el.innerHTML = `<span class="muted">Address:</span> <span class="addr">${addr}</span>`;
        } else {
          el.innerHTML = `<span class="muted">Address:</span> <span class="addr">Not available yet</span>`;
        }
      } catch (e){
        // Permission denied or missing — keep hidden, show hint
        const el = document.getElementById(`addr-${jobId}`);
        if (el) el.innerHTML = `<span class="muted">Address:</span> <span class="addr locked">Hidden (will appear after claim)</span>`;
      }
    }

    // Data caches
    let openJobs = []; // {id, ...data}
    let myJobs = [];

    function renderOpenJobs(){
      // Apply service filters
      const filtered = openJobs.filter(j=>{
        if (filterSet.size === 0) return true;
        const key = String(j.serviceType||'').toLowerCase();
        return filterSet.has(key);
      });
      openList.innerHTML = '';
      filtered.forEach(j => openList.appendChild(cardOpen(j)));
      openEmpty.hidden = filtered.length > 0;
    }
    function renderMyJobs(){
      myList.innerHTML = '';
      myJobs.forEach(j => myList.appendChild(cardMine(j)));
      myEmpty.hidden = myJobs.length > 0;
    }

    async function claimJob(jobId){
      if (!me) return;
      try{
        await runTransaction(db, async (tx)=>{
          const ref = doc(db, 'jobs', jobId);
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error('Job not found.');
          const cur = snap.data();
          if ((cur.status||'open') !== 'open') throw new Error('This job has already been claimed.');
          tx.update(ref, {
            status: 'claimed',
            contractorId: me.uid,
            contractorEmail: me.email || null,
            claimedAt: serverTimestamp()
          });
        });
        // Move user to My Jobs tab after claim
        tabMine.click();
      } catch(e){
        console.warn(e);
        toast(`Couldn’t claim: ${e.message || e.code || e}`);
      }
    }

    async function updateStatus(jobId, status){
      try{
        const ref = doc(db,'jobs',jobId);
        await updateDoc(ref,{ status });
        toast(`Status updated to “${status}”.`);
      } catch(e){
        toast('Update failed.');
      }
    }

    function toast(msg){
      errEl.textContent = msg;
      errEl.hidden = false;
      setTimeout(()=> errEl.hidden = true, 2600);
    }

    // --- Auth gate & boot ---
    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        // send to login and bounce back here
        const next = encodeURIComponent('contractor.html');
        window.location.href = `login.html?next=${next}`;
        return;
      }
      me = user;

      // Load profile
      const pRef = doc(db,'users', me.uid);
      const pSnap = await getDoc(pRef);
      meProfile = pSnap.exists() ? pSnap.data() : { role:'contractor', serviceTypes:['cleaning','organizing','decor','holiday'] };

      const role = String(meProfile.role || '').toLowerCase();
      roleChip.textContent = role ? role : 'unknown';
      roleChip.title = role ? `Signed in as ${role}` : 'Signed in';

      if (role !== 'contractor' && role !== 'admin'){
        errEl.hidden = false;
        errEl.textContent = 'Your account does not have contractor access. Please contact the admin.';
        // Stop here (no queries)
        return;
      }

      // Allowed service filters (default if missing)
      const st = Array.isArray(meProfile.serviceTypes) ? meProfile.serviceTypes : ['cleaning','organizing','decor','holiday'];
      allowed = st.map(s => String(s).toLowerCase());
      buildFilters();

      // Subscribe to Open Jobs
      // Strategy:
      //  - Read all open jobs, then filter client-side to allowed services (avoids composite index gotchas)
      const openQ = query(collection(db,'jobs'), where('status','==','open'));
      onSnapshot(openQ, (snap)=>{
        const rows = [];
        snap.forEach(d=>{
          const x = d.data();
          const key = String(x.serviceType||'').toLowerCase();
          // Only keep ones in allowed service types
          if (allowed.includes(key)) rows.push({ id: d.id, ...x });
        });
        // sort newest first by createdAt/claimedAt if present
        rows.sort((a,b)=>{
          const ta = (a.createdAt?.seconds||0);
          const tb = (b.createdAt?.seconds||0);
          return tb - ta;
        });
        openJobs = rows;
        renderOpenJobs();
      });

      // Subscribe to My Jobs (claimed by me)
      const mineQ = query(collection(db,'jobs'), where('contractorId','==', me.uid));
      onSnapshot(mineQ, (snap)=>{
        const rows = [];
        snap.forEach(d => rows.push({ id:d.id, ...d.data() }));
        // Show claimed first, then in-progress, submitted, etc. (simple sort by status + claimedAt desc)
        const order = { 'claimed':1, 'in-progress':2, 'submitted':3, 'approved':4, 'paid':5 };
        rows.sort((a,b)=>{
          const sa = order[a.status] || 99, sb = order[b.status] || 99;
          if (sa !== sb) return sa - sb;
          const ta = (a.claimedAt?.seconds||0), tb = (b.claimedAt?.seconds||0);
          return tb - ta;
        });
        myJobs = rows;
        renderMyJobs();
      });

      // Sign out
      document.getElementById('signOutBtn').addEventListener('click', async ()=>{
        await signOut(auth);
        location.href = 'index.html';
      });
    });
  </script>
</body>
</html>



