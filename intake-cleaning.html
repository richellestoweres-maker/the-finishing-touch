<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cleaning Intake ‚Äì The Finishing Touch</title>

  <!-- Fonts + Site CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <!-- Page-only helpers -->
  <style>
    body{background:#fbf8f4}
    .intake-wrap{width:min(920px,92%);margin:28px auto 60px;background:#fff;padding:28px 24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .intake-title{text-align:center;font-family:"Playfair Display",serif;margin:6px 0 2px}
    .intake-script{text-align:center;font-family:"Allura",cursive;font-size:2rem;margin:0 0 12px;color:#524a46}
    .intake-note{max-width:760px;margin:0 auto 18px;text-align:center;opacity:.9}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-1{display:grid;gap:14px}
    .fieldset{border-top:1px solid #e8ddd1;margin-top:16px;padding-top:16px}
    .submit-row{text-align:center;margin-top:16px}
    .brand a.brand-link{display:flex;align-items:center;gap:.5rem;color:inherit;text-decoration:none}
    .quote-dropdown{position:relative;display:inline-block}
    .quote-button, .btn.btn-solid{cursor:pointer}
    .quote-menu{
      position:absolute; right:0; top:calc(100% + 6px);
      background:#fff; border:1px solid #e8ddd1; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:8px; min-width:220px; display:none; z-index:50;
    }
    .quote-menu a{display:block; padding:10px 12px; border-radius:8px; color:#2a2624; text-decoration:none}
    .quote-menu a:hover{background:#f3ece6}
    .quote-dropdown.open .quote-menu{display:block}
    .mini-bar{width:min(920px,92%);margin:12px auto 0;text-align:center}
    .hint{font-size:.92rem;opacity:.9}
  </style>
</head>
<body>
  <!-- Header (routes back to CLIENT portal, not public home) -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a href="client.html" class="brand-link">
          <span class="vase-logo" aria-hidden="true"></span>
          <span class="brand-name">The Finishing Touch</span>
        </a>
      </div>
      <nav class="main-nav">
        <a href="client.html">Client Portal</a>

        <div class="quote-dropdown" id="quoteDropdown">
          <button class="btn btn-solid" id="quoteBtn" aria-expanded="false" aria-controls="quoteMenu">
            Get Your Quote ‚ñæ
          </button>
          <div class="quote-menu" id="quoteMenu" role="menu" aria-hidden="true">
            <a role="menuitem" href="intake-cleaning.html">Cleaning</a>
            <a role="menuitem" href="intake-organizing.html">Organizing</a>
            <a role="menuitem" href="intake-decor.html">Interior Decorating</a>
            <a role="menuitem" href="intake-holiday.html">Holiday & Event (Indoor)</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <div class="mini-bar">
    <a class="btn btn-outline" href="client.html">‚Üê Back to Client Portal</a>
  </div>

  <!-- Main -->
  <main class="intake-wrap">
    <h1 class="intake-title">The Finishing Touch</h1>
    <div class="intake-script">Cleaning Intake Form</div>
    <p class="intake-note">Complete this brief form for an instant ballpark estimate.</p>

    <form id="intakeFormCleaning" class="grid-1" novalidate>
      <div class="grid-2">
        <label>Full Name<input name="name" autocomplete="name" required></label>
        <label>Email<input name="email" type="email" autocomplete="email" required></label>
        <label>Service Address<input name="address" autocomplete="street-address"></label>
        <label>Phone<input name="phone" type="tel" autocomplete="tel"></label>
      </div>

      <div class="fieldset grid-2">
        <label>Service Type
          <select name="service">
            <option>Initial Clean</option>
            <option>Standard Clean</option>
            <option>Deep Clean</option>
            <option>Move-In / Move-Out Clean</option>
            <option>Airbnb Turnover</option>
          </select>
        </label>
        <label>Frequency
          <select name="frequency">
            <option>one-time</option><option>weekly</option>
            <option>biweekly</option><option>monthly</option>
          </select>
        </label>
        <label>Last Pro Clean<input name="last_cleaned" placeholder="e.g., 3 months ago"></label>
        <label>Availability<input name="availability" placeholder="e.g., Tue/Thu mornings"></label>
      </div>

      <div class="fieldset grid-2">
        <label>Bedrooms<input name="beds" type="number" min="0" value="3"></label>
        <label>Bathrooms<input name="baths" type="number" min="0" value="2"></label>
        <label>Other Rooms<input name="other_rooms" type="number" min="0" value="0"></label>
        <label>Square Footage
          <select name="sqft">
            <option>&lt;1000</option><option>1000‚Äì2000</option>
            <option>2000‚Äì3000</option><option>3000‚Äì4000</option><option>4000+</option>
          </select>
        </label>
        <label>Stories
          <select name="stories"><option>1</option><option>2</option></select>
        </label>
        <label>Pets (type & number)<input name="pets" /></label>
        <label>Areas of Focus<input name="notes" /></label>
      </div>

      <div class="fieldset grid-2">
        <label>Add-ons<input name="addons" placeholder="oven, fridge, windows, baseboards, laundry"></label>
        <label>Payment Method
          <select name="pay"><option>Zelle</option><option>Venmo</option><option>Cash</option><option>Cash App</option></select>
        </label>
      </div>

      <!-- CONSENTS -->
      <fieldset class="fieldset grid-1" aria-labelledby="consentLegend">
        <legend id="consentLegend" style="font-weight:700;">Consents</legend>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_work_photos" required>
          <span>I allow The Finishing Touch to take before/after photos for job verification and quality control. These will not be used for marketing unless I also consent below.</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_marketing_photos">
          <span>I give permission to use select photos of my space for marketing (website/social). Street address and personal items will not be shown. I can revoke this in writing.</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_terms" required>
          <span>I agree to the service terms (scheduling, access, cancellation, and safety). <a href="terms.html#client-terms" target="_blank" rel="noopener">Read terms</a>.</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_updates">
          <span>Okay to contact me by email/SMS with scheduling and project updates.</span>
        </label>
      </fieldset>

      <div class="submit-row">
        <button class="btn btn-solid" type="submit">Get Instant Estimate</button>
        <p id="estimateCleaning" class="hero-sub" style="color:#524a46;margin-top:10px;"></p>
        <!-- Book button is injected here after estimate -->
        <p id="formspreeStatusCleaning" style="opacity:.9"></p>
      </div>
    </form>
  </main>

  <!-- Dropdown behavior -->
  <script>
    (function(){
      const dd  = document.getElementById('quoteDropdown');
      const btn = document.getElementById('quoteBtn');
      const menu= document.getElementById('quoteMenu');
      if (!dd || !btn || !menu) return;
      function toggle(open){
        dd.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
        menu.setAttribute('aria-hidden', String(!open));
      }
      btn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(!dd.classList.contains('open')); });
      document.addEventListener('click', (e)=>{ if (!dd.contains(e.target)) toggle(false); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') toggle(false); });
    })();
  </script>

  <!-- Gate: require login for intake pages -->
  <script type="module">
    import { auth } from "./ft-firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        const next = encodeURIComponent('intake-cleaning.html');
        location.href = `login.html?next=${next}`;
      }
    });
  </script>

  <!-- Your site JS (bumped cache so the fixed file loads) -->
  <script src="script.js?v=8" defer></script>
  <!-- Optional helper that exposes FTAuto.createJobFromIntake(...) -->
  <script src="ft-auto.js" defer></script>

  <!-- OVERRIDE: Estimate on-page + ‚ÄúBook Now‚Äù + create Firestore job (if ft-auto.js present) + Formspree -->
  <script>
    (function(){
      // Square service URLs by team-hours bucket
      const SQUARE_CLEAN_SMALL  ="https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9/services/B7HOTUU7R3PZTXU3KDWVTUGN";
      const SQUARE_CLEAN_MEDIUM ="https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9/services/7DCTTLC4L6RT5ITF2NXHC2UJ";
      const SQUARE_CLEAN_LARGE  ="https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9/services/54JN4EKJXG6FU5G7PWWNHSAV";
      const SQUARE_CLEAN_XL     ="https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9/services/TJ25PH72FBCZ246QF27JR2RK";

      function roundHalf(n){ return Math.round(n*2)/2; }

      // Fallback hours estimator if the global one isn't loaded yet
      function estimateHoursCleaningLocal(data){
        try { if (typeof estimateHoursCleaning === 'function') return estimateHoursCleaning(data); } catch(_){}
        const sqft = data.sqft || "1000‚Äì2000";
        const service = data.service || "Initial Clean";
        const beds = Number(data.beds||0);
        const baths = Number(data.baths||0);
        const otherRooms = Number(data.other_rooms||0);
        const stories = String(data.stories||"1");

        let solo = 2;
        if (sqft === "<1000") solo = 2;
        else if (sqft === "1000‚Äì2000") solo = 3;
        else if (sqft === "2000‚Äì3000") solo = 4;
        else if (sqft === "3000‚Äì4000") solo = 5;
        else solo = 6;

        if (service === "Airbnb Turnover"){
          if (beds <= 1) solo = 2;
          else if (beds === 2) solo = 2.5;
          else if (beds === 3) solo = 3;
          else if (beds === 4) solo = 3.5;
          else solo = 4;
        }
        solo += Math.max(0, beds - 3) * 0.5;
        solo += Math.max(0, baths - 2) * 0.75;
        solo += Math.max(0, otherRooms) * 0.25;
        if (stories === "2") solo += 0.25;

        if (service === "Deep Clean") solo *= 1.5;
        if (service === "Move-In / Move-Out Clean") solo *= 2;
        if (service === "Initial Clean") solo *= 1.2;

        solo = roundHalf(solo);
        const team = roundHalf(solo / 2);
        return { soloHours: solo, teamHours: team };
      }

      function squareUrlForCleaningLocal(teamHours){
        if (teamHours <= 2.5) return SQUARE_CLEAN_SMALL;
        if (teamHours <= 3.5) return SQUARE_CLEAN_MEDIUM;
        if (teamHours <= 5)   return SQUARE_CLEAN_LARGE;
        return SQUARE_CLEAN_XL;
      }

      function cleaningHintLocal(data, teamHours){
        const service = data.service || "Initial Clean";
        if (service === "Standard Clean"){
          const sqft = data.sqft || "1000‚Äì2000";
          const label = {"<1000":"Small (‚â§1,000 sq ft)","1000‚Äì2000":"Medium (1,000‚Äì2,000)","2000‚Äì3000":"Large (2,000‚Äì3,000)","3000‚Äì4000":"XL (3,000‚Äì4,000)","4000+":"Estate (4,000+)"}[sqft] || "Sized by intake";
          return `Standard Clean ‚Äî ${label}`;
        }
        if (service === "Airbnb Turnover"){
          if (teamHours <= 2.5) return "Airbnb Turnover ‚Äî Quick (~2 hr)";
          if (teamHours <= 3.5) return "Airbnb Turnover ‚Äî Standard (~3 hr)";
          if (teamHours <= 5)   return "Airbnb Turnover ‚Äî Extended (~4‚Äì5 hr)";
          return "Airbnb Turnover ‚Äî Extended XL (5.5+ hr)";
        }
        if (teamHours <= 2.5) return `${service} ‚Äî Small (~2‚Äì2.5 hr)`;
        if (teamHours <= 3.5) return `${service} ‚Äî Medium (~3‚Äì3.5 hr)`;
        if (teamHours <= 5)   return `${service} ‚Äî Large (~4‚Äì5 hr)`;
        return `${service} ‚Äî XL (5.5+ hr)`;
      }

      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('intakeFormCleaning');
        if (!form) return;

        // Capture phase so we cancel any site-wide handler that redirects
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          e.stopImmediatePropagation();

          const data = Object.fromEntries(new FormData(form).entries());

          // 1) Show price estimate
          const estEl = document.getElementById('estimateCleaning');
          let price = null;
          try {
            if (typeof calcCleaning === 'function') price = calcCleaning(data);
            if (estEl){
              if (price != null) {
                estEl.innerHTML = `Ballpark Estimate: <strong>$${price}</strong>`;
              } else {
                estEl.textContent = "Ballpark estimate ready.";
              }
            }
          } catch (err){ console.warn(err); }

          // 2) Pick Square URL based on estimated team hours
          const { teamHours, soloHours } = estimateHoursCleaningLocal(data);
          const url = (typeof squareUrlForCleaning === 'function')
            ? squareUrlForCleaning(teamHours)
            : squareUrlForCleaningLocal(teamHours);

          // Inject/refresh the ‚ÄúBook Now‚Äù button under the estimate
          let btn = document.getElementById('scheduleOnSquareCleaning');
          if (!btn){
            btn = document.createElement('a');
            btn.id = 'scheduleOnSquareCleaning';
            btn.className = 'btn btn-solid';
            btn.style.marginTop = '10px';
            btn.textContent = 'Book Now';
            estEl.parentNode.insertBefore(btn, estEl.nextSibling);
          }
          btn.href = url;
          btn.target = '_blank';
          btn.rel = 'noopener';

          // Optional guidance line (recommended option)
          const hint = cleaningHintLocal(data, teamHours);
          let hintEl = document.getElementById('cleaningHint');
          if (!hintEl){
            hintEl = document.createElement('p');
            hintEl.id = 'cleaningHint';
            hintEl.className = 'hint';
            btn.parentNode.insertBefore(hintEl, btn.nextSibling);
          }
          hintEl.textContent = `Recommended service: ${hint}. This opens our Square calendar in a new tab.`;

          // 3) Try to create a Firestore job via helper (non-blocking)
          try {
            if (window.FTAuto && typeof FTAuto.createJobFromIntake === 'function'){
              const summary = `${Number(data.beds||0)} bed / ${Number(data.baths||0)} bath ‚Äî ${data.service||'Cleaning'}`.trim();
              await FTAuto.createJobFromIntake({
                serviceType: 'cleaning',
                summary,
                estTeamHours: teamHours,
                flatRate: (price!=null? Number(price) : null),
                intake: data
              });
            }
          } catch (err) {
            console.warn('Could not create job from intake (ok to ignore):', err);
          }

          // 4) Send to Formspree in the background (FYI trail)
          const statusEl = document.getElementById('formspreeStatusCleaning');
          try {
            const estText = estEl?.textContent?.trim() || '';
            const fsData = new FormData(form);
            fsData.append('_subject', 'Cleaning Intake');
            fsData.append('form_name', 'Cleaning Intake');
            fsData.append('page', location.href);
            if (estText) fsData.append('estimate', estText);
            fsData.append('team_hours', String(teamHours));
            fsData.append('solo_hours', String(soloHours));
            if (price!=null) fsData.append('price', `$${Math.round(Number(price))}`);

            const resp = await fetch('https://formspree.io/f/mzzaogbv', {
              method: 'POST',
              body: fsData,
              headers: { 'Accept': 'application/json' }
            });

            if (resp.ok) {
              if (statusEl) statusEl.textContent = 'Thanks! Your intake was sent.';
            } else {
              if (statusEl) statusEl.textContent = 'Estimate shown above. We couldn‚Äôt send the form right now.';
            }
          } catch (err) {
            if (statusEl) statusEl.textContent = 'Estimate shown above. We couldn‚Äôt send the form right now.';
            console.warn(err);
          }
        }, true);
      });
    })();
  </script>

  <!-- Chat (same UX as other pages) -->
  <div id="ftt-chat-launcher" aria-label="Open chat" role="button">üí¨</div>
  <div id="ftt-chat" aria-live="polite" aria-label="Chat window" hidden>
    <div class="ftt-chat-header">
      <div>
        <div class="ftt-title">The Finishing Touch</div>
        <div class="ftt-subtitle">AI Concierge ‚Ä¢ human on request</div>
      </div>
      <button class="ftt-close" aria-label="Close chat">√ó</button>
    </div>
    <div id="ftt-thread" class="ftt-thread"></div>
    <form id="ftt-inputbar" class="ftt-inputbar" autocomplete="off">
      <input id="ftt-input" name="message" type="text" placeholder="Ask about pricing, availability, services‚Ä¶" aria-label="Type your message" required />
      <button class="ftt-send" type="submit">Send</button>
    </form>
    <div class="ftt-quick">
      <button data-q="pricing">Pricing</button>
      <button data-q="availability">Availability</button>
      <button data-q="services">Services</button>
      <button data-q="book">Book now</button>
      <button data-q="human">Talk to a person</button>
      <button data-q="help">Help me choose</button>
    </div>
  </div>

  <script>
    // Self-contained chat (same tone as Home).
    (function(){
      const FTT_CFG = {
        timezone: "America/Chicago",
        intakeAnchor: "intake-cleaning.html",
        bookUrl: "https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9",
        email: "contact.thefinishingtouch.tx@gmail.com",
        messengerDeepLink: "https://m.me/thefinishingtouch.tx",
        hours: { days:[1,2,3,4,5], open:"09:00", close:"17:00" },
      };
      const el = {
        launcher: document.getElementById("ftt-chat-launcher"),
        panel: document.getElementById("ftt-chat"),
        thread: document.getElementById("ftt-thread"),
      };
      function addMsg(html, who="bot"){
        const b=document.createElement("div");
        b.className=`ftt-bubble ${who}`; b.innerHTML=html;
        el.thread.appendChild(b); el.thread.scrollTop=el.thread.scrollHeight;
      }
      function detectIntent(text){
        const t=text.toLowerCase();
        if (/(human|person|agent|representative|someone|call|talk to)/.test(t)) return "human";
        if (/(price|pricing|cost|rate|how much)/.test(t)) return "pricing";
        if (/(avail|slot|appointment|when|schedule|open)/.test(t)) return "availability";
        if (/(service|deep|standard|move[-\s]?out|organize|staging|what do you do)/.test(t)) return "services";
        if (/(book|booking|schedule now)/.test(t)) return "book";
        if (/(which|help choose|recommend|not sure|what should i (pick|choose)|suggest)/.test(t)) return "recommend";
        return "fallback";
      }
      function answer(intent){
        const intakeLink = `<a href="${FTT_CFG.intakeAnchor}">Start Intake</a>`;
        const bookLink = `<a href="${FTT_CFG.bookUrl}" target="_blank" rel="noopener">Book now</a>`;
        switch(intent){
          case "pricing":
            return [
              "Here‚Äôs a quick pricing overview (final quote depends on size/condition):",
              "‚Ä¢ Initial/Deep Clean: typically $350‚Äì$400 for average homes.",
              "‚Ä¢ Standard Maintenance: commonly $275‚Äì$300.",
              "We‚Äôll tailor it after your intake. " + intakeLink + " or " + bookLink + "."
            ].join("<br>");
          case "availability":
            return ["We update availability live in Square.", bookLink + " to see current openings, or " + intakeLink + " and I‚Äôll route you."].join("<br>");
          case "services":
            return [
              "We offer luxury cleaning, organizing, staging, and seasonal refresh.",
              "‚Ä¢ Deep/Initial: top-to-bottom detail.",
              "‚Ä¢ Standard: recurring maintenance (weekly/bi-weekly/monthly).",
              "‚Ä¢ Move-Out/Make-Ready: includes inside cabinets, fridge, oven (by request).",
              "Want the full checklist? " + intakeLink + " and I‚Äôll tailor it to your home."
            ].join("<br>");
          case "book": return "Perfect‚Äî" + bookLink + " or " + intakeLink + " if you‚Äôd like a quick tailored route first.";
          case "human":
            return `You can <a href="${FTT_CFG.messengerDeepLink}" target="_blank" rel="noopener">message us on Facebook</a> or email <a href="mailto:${FTT_CFG.email}">${FTT_CFG.email}</a> and we‚Äôll reply ASAP.`;
          case "recommend":
            return [
              "<strong>Happy to help you choose!</strong>",
              "<em>Initial:</em> A ‚âà up to ~1,200 sq ft ¬∑ B ‚âà ~1,200‚Äì2,000 ¬∑ C ‚âà ~2,000‚Äì3,000 ¬∑ D ‚âà 3,000+ / heavy detail.",
              "<em>Standard:</em> A ‚âà up to ~1,200 ¬∑ B ‚âà ~1,200‚Äì2,000 ¬∑ C ‚âà ~2,000‚Äì3,000 (larger? pick Deep).",
              "<em>Move-Out:</em> 5 hr ‚âà up to ~1,500 sq ft ¬∑ 7 hr ‚âà ~1,500‚Äì3,000+ sq ft.",
              `Ready to book? ${bookLink} (Square opens in a new tab). Or ${intakeLink} for a tailored estimate first.`
            ].join("<br>");
          default:
            return ["I can help with pricing, availability, and services.", "Try asking ‚Äúwhat‚Äôs your pricing?‚Äù or ‚Äúdo you have Friday slots?‚Äù", "Say ‚Äúhuman‚Äù any time to talk to a person."].join("<br>");
        }
      }
      function init(){
        const launcher = document.getElementById("ftt-chat-launcher");
        const panel = document.getElementById("ftt-chat");
        const thread = document.getElementById("ftt-thread");
        const closeBtn = document.querySelector(".ftt-close");
        const form = document.getElementById("ftt-inputbar");
        const input = document.getElementById("ftt-input");
        const quick = document.querySelector(".ftt-quick");
        function add(html, who="bot"){ const b=document.createElement("div"); b.className=`ftt-bubble ${who}`; b.innerHTML=html; thread.appendChild(b); thread.scrollTop=thread.scrollHeight; }
        launcher.addEventListener("click", ()=>{ panel.hidden=false; if (!thread.dataset.greeted){ add("Hi! I‚Äôm your AI concierge for The Finishing Touch. Ask me about pricing, availability, or services. Say ‚Äúhuman‚Äù anytime.","bot"); thread.dataset.greeted="1"; } input.focus(); });
        closeBtn.addEventListener("click", ()=>{ panel.hidden=true; });
        form.addEventListener("submit",(e)=>{ e.preventDefault(); const text=input.value.trim(); if(!text) return; add(text,"me"); input.value=""; setTimeout(()=> add(answer((text||"").toLowerCase())),200); });
        quick.addEventListener("click",(e)=>{ if(e.target.matches("button[data-q]")){ const map={pricing:"pricing",availability:"availability",services:"services",book:"book",human:"human",help:"recommend"}; const intent=map[e.target.getAttribute("data-q")]||"fallback"; add(e.target.textContent,"me"); setTimeout(()=> add(answer(intent)),200); } });
      }
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
