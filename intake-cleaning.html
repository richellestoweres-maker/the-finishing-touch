<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cleaning Intake – The Finishing Touch</title>

  <!-- Fonts + Site CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <!-- Page-only helpers -->
  <style>
    body{background:#fbf8f4}
    .intake-wrap{width:min(920px,92%);margin:28px auto 60px;background:#fff;padding:28px 24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .intake-title{text-align:center;font-family:"Playfair Display",serif;margin:6px 0 2px}
    .intake-script{text-align:center;font-family:"Allura",cursive;font-size:2rem;margin:0 0 12px;color:#524a46}
    .intake-note{max-width:760px;margin:0 auto 18px;text-align:center;opacity:.9}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-1{display:grid;gap:14px}
    .fieldset{border-top:1px solid #e8ddd1;margin-top:16px;padding-top:16px}
    .submit-row{text-align:center;margin-top:16px}
    .brand a.brand-link{display:flex;align-items:center;gap:.5rem;color:inherit;text-decoration:none}
    .quote-dropdown{position:relative;display:inline-block}
    .quote-button, .btn.btn-solid{cursor:pointer}
    .quote-menu{
      position:absolute; right:0; top:calc(100% + 6px);
      background:#fff; border:1px solid #e8ddd1; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:8px; min-width:220px; display:none; z-index:50;
    }
    .quote-menu a{display:block; padding:10px 12px; border-radius:8px; color:#2a2624; text-decoration:none}
    .quote-menu a:hover{background:#f3ece6}
    .quote-dropdown.open .quote-menu{display:block}
    .mini-bar{width:min(920px,92%);margin:12px auto 0;text-align:center}
    .hint{font-size:.92rem;opacity:.9}

    /* Success card */
    .success-card{
      margin-top:14px;
      background:#fbf5ee;
      border:1px solid #ecdccc;
      border-radius:14px;
      padding:14px 16px;
      font-size:.98rem;
      display:none;
      text-align:center;
    }
  </style>
</head>

<body>
  <!-- Header (routes back to CLIENT portal, not public home) -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a href="client.html" class="brand-link">
          <span class="vase-logo" aria-hidden="true"></span>
          <span class="brand-name">The Finishing Touch</span>
        </a>
      </div>
      <nav class="main-nav">
        <a href="client.html">Client Portal</a>

        <div class="quote-dropdown" id="quoteDropdown">
          <button class="btn btn-solid" id="quoteBtn" aria-expanded="false" aria-controls="quoteMenu">
            Get Your Quote ▾
          </button>
          <div class="quote-menu" id="quoteMenu" role="menu" aria-hidden="true">
            <a role="menuitem" href="intake-cleaning.html">Cleaning</a>
            <a role="menuitem" href="intake-organizing.html">Organizing</a>
            <a role="menuitem" href="intake-decor.html">Interior Decorating</a>
            <a role="menuitem" href="intake-holiday.html">Holiday & Event (Indoor)</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <div class="mini-bar">
    <a class="btn btn-outline" href="client.html">← Back to Client Portal</a>
  </div>

  <!-- Main -->
  <main class="intake-wrap">
    <h1 class="intake-title">The Finishing Touch</h1>
    <div class="intake-script">Cleaning Intake Form</div>
    <p class="intake-note">
      Complete this brief form so we can review your home and follow up with a tailored ballpark estimate and recommended next steps.
      Uploading photos/video (optional) helps us quote accurately.
    </p>

    <!-- Formspree (uploads enabled) -->
    <form id="intakeFormCleaning" class="grid-1"
          method="POST"
          action="https://formspree.io/f/mzzaogbv"
          enctype="multipart/form-data"
          novalidate>
      <input type="hidden" name="_subject" value="New Cleaning Intake · The Finishing Touch" />
      <input type="hidden" name="page" value="intake-cleaning.html" />

      <!-- Contact -->
      <div class="grid-2">
        <label>Full Name<input name="name" autocomplete="name" required></label>
        <label>Email<input name="email" type="email" autocomplete="email" required></label>
        <label>Service Address<input name="address" autocomplete="street-address"></label>
        <label>Phone<input name="phone" type="tel" autocomplete="tel"></label>
      </div>

      <!-- Service Details -->
      <div class="fieldset grid-2">
        <label>Service Type
          <select name="service" required>
            <option>Initial Clean</option>
            <option>Standard Clean</option>
            <option>Deep Clean</option>
            <option>Move-In / Move-Out Clean</option>
            <option>Airbnb Turnover</option>
          </select>
        </label>

        <label>Frequency
          <select name="frequency" required>
            <option value="one-time">one-time</option>
            <option value="weekly">weekly</option>
            <option value="biweekly">biweekly</option>
            <option value="monthly">monthly</option>
          </select>
        </label>

        <label>Last Professional Clean (optional)
          <input name="last_cleaned" placeholder="e.g., within 30 days / 3+ months / not sure">
        </label>

        <label>Preferred Days / Times
          <input name="availability" placeholder="e.g., Tue/Thu mornings">
        </label>
      </div>

      <!-- Home Details -->
      <div class="fieldset grid-2">
        <label>Bedrooms<input name="beds" type="number" min="0" value="3"></label>
        <label>Bathrooms<input name="baths" type="number" min="0" value="2"></label>
        <label>Other Rooms<input name="other_rooms" type="number" min="0" value="0"></label>

        <label>Square Footage (approx.)
          <input name="sqft" type="number" min="0" step="1" placeholder="e.g., 1750">
        </label>

        <label>Stories
          <select name="stories"><option>1</option><option>2</option></select>
        </label>

        <label>Pets (type & number)<input name="pets" placeholder="e.g., 1 dog, 2 cats"></label>

        <label>Areas of Focus
          <input name="notes" placeholder="e.g., bathrooms, baseboards, kitchen detail">
        </label>
      </div>

      <!-- Add-ons + Pay -->
      <div class="fieldset grid-2">
        <label>Add-ons
          <input name="addons" placeholder="oven, fridge, inside windows, baseboards, laundry">
        </label>
        <label>Payment Method
          <select name="pay" required>
            <option>Zelle</option><option>Venmo</option><option>Cash</option><option>Cash App</option>
          </select>
        </label>
      </div>

      <!-- Media Uploads -->
      <div class="fieldset grid-1">
        <p class="hint" style="margin:0 0 8px;">
          <strong>Photos/Video (optional):</strong> Upload <strong>3–10 photos</strong> and/or <strong>1 short video</strong> to help us quote accurately.
          Best shots: wide-angle of each room, bathrooms, kitchen, and any heavy buildup areas (baseboards, showers, stovetop, etc.).
        </p>

        <label>Upload Photos (3–10 max)
          <input name="media_photos" id="cleanMediaPhotos" type="file" accept="image/*" multiple>
        </label>

        <label>Upload Video (optional, short)
          <input name="media_video" id="cleanMediaVideo" type="file" accept="video/*">
        </label>

        <p class="hint" id="cleanUploadStatus" style="margin:6px 0 0;"></p>
      </div>

      <!-- CONSENTS -->
      <fieldset class="fieldset grid-1" aria-labelledby="consentLegend">
        <legend id="consentLegend" style="font-weight:700;">Consents</legend>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_work_photos" value="Yes" required>
          <span>I allow The Finishing Touch to take before/after photos for job verification and quality control. These will not be used for marketing unless I also consent below.</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_marketing_photos" value="Yes">
          <span>I give permission to use select photos of my space for marketing (website/social). Street address and personal items will not be shown. </span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_terms" value="Yes" required>
          <span>I agree to the service terms (scheduling, access, cancellation, and safety). <a href="terms.html#client-terms" target="_blank" rel="noopener">Read terms</a>.</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_updates" value="Yes">
          <span>Okay to contact me by email/SMS with scheduling, invoices, updates, and offers.</span>
        </label>
      </fieldset>

      <!-- Submit -->
      <div class="submit-row">
        <button class="btn btn-solid" type="submit" id="cleanSubmitBtn">Submit Cleaning Intake</button>
        <p id="formspreeStatusCleaning" class="hint" style="margin-top:10px;"></p>
        <div id="successCardCleaning" class="success-card" aria-live="polite"></div>
      </div>
    </form>
  </main>

  <!-- Dropdown behavior -->
  <script>
    (function(){
      const dd  = document.getElementById('quoteDropdown');
      const btn = document.getElementById('quoteBtn');
      const menu= document.getElementById('quoteMenu');
      if (!dd || !btn || !menu) return;
      function toggle(open){
        dd.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
        menu.setAttribute('aria-hidden', String(!open));
      }
      btn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(!dd.classList.contains('open')); });
      document.addEventListener('click', (e)=>{ if (!dd.contains(e.target)) toggle(false); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') toggle(false); });
    })();
  </script>

  <!-- Your site JS (optional; calcCleaning may live here) -->
  <script src="script.js?v=9" defer></script>

  <!-- Helper that exposes FTAuto.createJobFromIntake(...) -->
  <script src="ft-auto.js" defer></script>

  <!-- Cleaning internal pricing + payout engine + Formspree upload submission -->
  <script>
    (function(){
      // Upload constraints (adjust any time)
      const PHOTO_MIN = 3;
      const PHOTO_MAX = 10;
      const MAX_PHOTO_MB_EACH = 12; // optional guard
      const MAX_VIDEO_MB = 60;      // optional guard

      // Default subcontract model
      const SUBCONTRACT_COMPANY_PCT_DEFAULT = 0.60; // pay subs first (60% of client total)
      const TAX_PCT_OF_REMAINDER = 0.30;            // after subs
      const PROFIT_PCT_OF_REMAINDER = 0.20;         // after subs

      function bytesToMB(b){ return b / (1024 * 1024); }
      function roundHalf(n){ return Math.round(n * 2) / 2; }

      function validateUploads(photoInput, videoInput){
        const photos = photoInput?.files ? Array.from(photoInput.files) : [];
        const video  = videoInput?.files ? Array.from(videoInput.files) : [];

        // photos: allow 0 OR 3–10
        if (photos.length !== 0 && (photos.length < PHOTO_MIN || photos.length > PHOTO_MAX)){
          return `Please upload ${PHOTO_MIN}–${PHOTO_MAX} photos (or none). You selected ${photos.length}.`;
        }

        // video: allow 0 or 1
        if (video.length > 1){
          return "Please upload only 1 video.";
        }

        // optional file size checks
        const tooBigPhoto = photos.find(f => bytesToMB(f.size) > MAX_PHOTO_MB_EACH);
        if (tooBigPhoto){
          return `One of your photos is too large. Please keep each photo under ${MAX_PHOTO_MB_EACH}MB.`;
        }

        if (video[0] && bytesToMB(video[0].size) > MAX_VIDEO_MB){
          return `Your video is too large. Please keep it under ${MAX_VIDEO_MB}MB.`;
        }

        return null;
      }

      function setUploadHint(photoInput, videoInput, statusEl){
        const pCount = photoInput?.files?.length || 0;
        const vCount = videoInput?.files?.length || 0;
        if (!statusEl) return;
        if (!pCount && !vCount) { statusEl.textContent = ""; return; }
        statusEl.textContent = `Selected: ${pCount} photo(s)${vCount ? " + 1 video" : ""}.`;
      }

      // Fallback price calculator if global calcCleaning isn't available
      // Standard: weekly 0.14 / biweekly 0.16 / monthly 0.18
      // Initial: 0.18–0.22 midpoint 0.20
      // Deep: 0.22–0.28 midpoint 0.25
      // Move-in/out: 0.28–0.35 midpoint 0.30
      function calcCleaningLocal(data){
        const sqft = Number(data.sqft || 0) || 0;
        const service = data.service || 'Initial Clean';
        const frequency = data.frequency || 'one-time';
        if (!sqft) return null;

        let rate = 0.20; // default midpoint Initial

        if (service === 'Standard Clean'){
          if (frequency === 'weekly') rate = 0.14;
          else if (frequency === 'biweekly') rate = 0.16;
          else if (frequency === 'monthly') rate = 0.18;
          else rate = 0.18; // one-time standard behaves like monthly/reset
        } else if (service === 'Deep Clean'){
          rate = 0.25;
        } else if (service === 'Move-In / Move-Out Clean'){
          rate = 0.30;
        } else if (service === 'Airbnb Turnover'){
          rate = 0.25;
        } else if (service === 'Initial Clean'){
          rate = 0.20;
        }

        return sqft * rate;
      }

      // Simple hours estimator
      function estimateHoursCleaningLocal(data){
        const sqftNum = Number(data.sqft || 0) || 0;
        const beds = Number(data.beds || 0);
        const baths = Number(data.baths || 0);
        const otherRooms = Number(data.other_rooms || 0);
        const stories = String(data.stories || "1");
        const service = data.service || 'Initial Clean';

        let solo = 3;
        if (sqftNum > 0){
          solo = 1 + Math.ceil(sqftNum / 1000);
          solo = Math.min(Math.max(solo, 2), 6);
        }

        solo += Math.max(0, beds - 3) * 0.5;
        solo += Math.max(0, baths - 2) * 0.75;
        solo += Math.max(0, otherRooms) * 0.25;
        if (stories === "2") solo += 0.25;

        if (service === "Deep Clean") solo *= 1.5;
        if (service === "Move-In / Move-Out Clean") solo *= 2;
        if (service === "Initial Clean") solo *= 1.2;
        if (service === "Airbnb Turnover") solo *= 1.1;

        solo = roundHalf(solo);
        const team = roundHalf(solo / 2);
        return { soloHours: solo, teamHours: team };
      }

      function suggestCleanerCount(soloHours){
        if (soloHours <= 3) return 1;
        if (soloHours <= 6) return 2;
        if (soloHours <= 9) return 3;
        return 4;
      }

      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('intakeFormCleaning');
        if (!form) return;

        const statusEl = document.getElementById('formspreeStatusCleaning');
        const successCard = document.getElementById('successCardCleaning');
        const submitBtn = document.getElementById('cleanSubmitBtn');

        const photoInput = document.getElementById('cleanMediaPhotos');
        const videoInput = document.getElementById('cleanMediaVideo');
        const uploadStatus = document.getElementById('cleanUploadStatus');

        photoInput?.addEventListener('change', () => setUploadHint(photoInput, videoInput, uploadStatus));
        videoInput?.addEventListener('change', () => setUploadHint(photoInput, videoInput, uploadStatus));

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          e.stopImmediatePropagation();

          if (statusEl) statusEl.textContent = "";
          if (successCard){ successCard.style.display="none"; successCard.textContent=""; }

          // Validate uploads
          const uploadErr = validateUploads(photoInput, videoInput);
          if (uploadErr){
            if (statusEl) statusEl.textContent = uploadErr;
            return;
          }

          if (submitBtn){
            submitBtn.disabled = true;
            submitBtn.textContent = "Submitting…";
          }

          // Build FormData FROM THE FORM (includes files)
          const fd = new FormData(form);

          // Build plain data object for math (ignore file fields)
          const data = {};
          fd.forEach((v, k) => {
            if (k === "media_photos" || k === "media_video") return;
            data[k] = v;
          });

          data.sqft = (data.sqft || '').toString().trim();

          // Price estimate (internal only)
          let price = null;
          try{
            if (typeof calcCleaning === "function") price = calcCleaning(data);
            else price = calcCleaningLocal(data);
          } catch(err){ console.warn(err); }

          const totalPrice = price != null ? Number(price) : 0;

          // Hours + staffing suggestion
          const hours = estimateHoursCleaningLocal(data);
          const soloHours = hours.soloHours;
          const teamHours = hours.teamHours;
          const cleanerCount = suggestCleanerCount(soloHours);

          // ===== YOUR MODEL: pay subcontractor first, THEN taxes/profit are calculated on remainder =====
          const subPayAssumed = totalPrice * SUBCONTRACT_COMPANY_PCT_DEFAULT;
          const remainingAfterSub = Math.max(0, totalPrice - subPayAssumed);

          const taxReserve = remainingAfterSub * TAX_PCT_OF_REMAINDER;
          const profitTarget = remainingAfterSub * PROFIT_PCT_OF_REMAINDER;

          // This is your salary + overhead buffer from this job
          const ownerOpsLeftover = remainingAfterSub - taxReserve - profitTarget;

          // Per-cleaner suggestion if you do NOT use the subcontract company (you + 1–2 helpers)
          // Treat ownerOpsLeftover as YOUR bucket in the subcontract-company scenario.
          // For individual contractor scenario, you might instead allocate a chosen owner wage and split the rest.
          const OWNER_WAGE_SHARE_IF_INDIVIDUALS = 0.50; // of the remainderAfterSub conceptually (adjust anytime)
          const ownerWageSuggested_ifIndividuals = remainingAfterSub * OWNER_WAGE_SHARE_IF_INDIVIDUALS;
          const contractorsPoolSuggested_ifIndividuals = Math.max(0, remainingAfterSub - (remainingAfterSub * (TAX_PCT_OF_REMAINDER + PROFIT_PCT_OF_REMAINDER)) - ownerWageSuggested_ifIndividuals);
          const contractorPayEachSuggested_ifIndividuals = cleanerCount ? (contractorsPoolSuggested_ifIndividuals / cleanerCount) : 0;

          // Attach internal-only fields to Formspree email (client does not see these)
          if (totalPrice) fd.append("INTERNAL_price_estimate", `$${Math.round(totalPrice)}`);
          fd.append("INTERNAL_solo_hours", String(soloHours));
          fd.append("INTERNAL_team_hours", String(teamHours));
          fd.append("INTERNAL_cleaner_count_suggested", String(cleanerCount));

          fd.append("INTERNAL_subcontract_company_pct_assumed", String(Math.round(SUBCONTRACT_COMPANY_PCT_DEFAULT * 100)) + "%");
          fd.append("INTERNAL_subcontractor_pay_assumed", subPayAssumed.toFixed(2));
          fd.append("INTERNAL_remaining_after_sub", remainingAfterSub.toFixed(2));

          fd.append("INTERNAL_tax_reserve_30pct_of_remaining", taxReserve.toFixed(2));
          fd.append("INTERNAL_profit_target_20pct_of_remaining", profitTarget.toFixed(2));
          fd.append("INTERNAL_owner_ops_leftover_after_tax_profit", ownerOpsLeftover.toFixed(2));

          // Optional internal guidance line to help you quickly decide
          fd.append("INTERNAL_payout_summary",
            `Client $${Math.round(totalPrice)} | Sub (60%) $${Math.round(subPayAssumed)} | Remainder $${Math.round(remainingAfterSub)} | Taxes(30%) $${Math.round(taxReserve)} | Profit(20%) $${Math.round(profitTarget)} | Owner/Ops $${Math.round(ownerOpsLeftover)}`
          );

          fd.append("INTERNAL_rate_framework_note",
            "Standard: weekly 0.14 / biweekly 0.16 / monthly 0.18 | Initial: 0.18–0.22 | Deep: 0.22–0.28 | Move: 0.28–0.35"
          );

          // Create Firestore job (if available)
          try{
            if (window.FTAuto && typeof FTAuto.createJobFromIntake === "function"){
              const summary = `${Number(data.beds||0)} bed / ${Number(data.baths||0)} bath — ${data.service||'Cleaning'}`.trim();
              await FTAuto.createJobFromIntake({
                type: "cleaning",
                intakeData: data,
                estimate: {
                  price: totalPrice,
                  soloHours,
                  teamHours,
                  cleanerCount,
                  subcontractPctAssumed: SUBCONTRACT_COMPANY_PCT_DEFAULT,
                  subPayAssumed,
                  remainingAfterSub,
                  taxReserve,
                  profitTarget,
                  ownerOpsLeftover,
                  ownerWageSuggested_ifIndividuals,
                  contractorsPoolSuggested_ifIndividuals,
                  contractorPayEachSuggested_ifIndividuals
                },
                summary
              });
            }
          } catch(err){
            console.warn("Could not create job from intake (ok to ignore):", err);
          }

          // Submit to Formspree (includes file uploads)
          try{
            const resp = await fetch(form.action, {
              method: "POST",
              headers: { "Accept": "application/json" },
              body: fd
            });

            if (resp.ok){
              if (statusEl) statusEl.textContent = "";
              if (successCard){
                successCard.textContent =
                  "Thanks! We’ve received your intake. We’ll review your details and follow up with a tailored ballpark estimate and next steps.";
                successCard.style.display = "block";
              }
              form.reset();
              if (uploadStatus) uploadStatus.textContent = "";
            } else {
              if (statusEl) statusEl.textContent =
                "We received your intake, but couldn’t send the email copy right now. If needed, please email us directly.";
            }
          } catch(err){
            console.warn(err);
            if (statusEl) statusEl.textContent =
              "We received your intake, but your connection seems unstable. If you don’t hear back soon, please email us directly.";
          } finally {
            if (submitBtn){
              submitBtn.disabled = false;
              submitBtn.textContent = "Submit Cleaning Intake";
            }
          }
        }, true);
      });
    })();
  </script>

  <!-- Optional shared chat guard (if you use it elsewhere) -->
  <script src="ftt-chat.js" defer></script>
</body>
</html>







