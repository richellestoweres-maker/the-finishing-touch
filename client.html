<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client Portal – The Finishing Touch</title>

  <!-- Fonts + Site CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body{background:var(--paper,#fbf8f4)}
    .portal{width:min(1100px,94%);margin:24px auto 60px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:#fff;padding:12px 16px;border-radius:14px;box-shadow:var(--shadow,0 10px 30px rgba(0,0,0,.08))
    }
    .brand-mini{display:flex;align-items:center;gap:.6rem}
    .brand-mini .vase-logo{width:28px;height:36px;background:url('logo-vase.png') center/contain no-repeat;display:inline-block}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:999px;font-weight:800;text-decoration:none;cursor:pointer}
    .btn-outline{border:1.5px solid #2e2a27;background:#fff;color:#2e2a27}
    .btn-solid{background:var(--accent,#d2bda9);color:#2a2624;border:0}
    .grid{display:grid;gap:14px}
    .grid-cols{grid-template-columns:1.1fr .9fr}
    @media (max-width:1000px){.grid-cols{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .muted{opacity:.85}
    .list a{display:inline-block;margin:.25rem .35rem 0 0}
    .inline-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{border:1px solid #e3d9ce;border-radius:999px;padding:.2rem .6rem;background:#fffdfb;font-weight:700;font-size:.85rem}
  </style>
</head>
<body>
  <div class="portal">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand-mini">
        <span class="vase-logo" aria-hidden="true"></span>
        <div>
          <div style="font-family:'Playfair Display',serif;line-height:1;color:#2e2a27;">The Finishing Touch</div>
          <div class="muted" id="whoami">Loading…</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn btn-outline" href="index.html">Home</a>
        <a id="signOutBtn" class="btn btn-outline" href="#">Sign out</a>
      </div>
    </div>

    <!-- Main content -->
    <section class="grid grid-cols" style="margin-top:14px;">
      <div class="card">
        <h2 style="margin:0 0 .25rem">Welcome 👋</h2>
        <p class="muted" id="greeting">Let’s get you scheduled.</p>

        <div class="inline-badges" style="margin:8px 0 12px">
          <span class="badge">Instant quote</span>
          <span class="badge">Book in 1–2 min</span>
          <span class="badge">Update/cancel anytime</span>
        </div>

        <div class="list">
          <a class="btn btn-solid" href="intake-cleaning.html">Cleaning — Start Intake</a>
          <a class="btn btn-solid" href="intake-organizing.html">Organizing — Start Intake</a>
          <a class="btn btn-solid" href="intake-decor.html">Interior Decorating — Start Intake</a>
          <a class="btn btn-solid" href="intake-holiday.html">Holiday (Indoor) — Start Intake</a>
        </div>

        <p class="muted" style="margin-top:12px">
          Your intake shows a tailored ballpark on the page and emails a copy. Then click <strong>Book Now</strong> to jump to our calendar with the recommended time block.
        </p>

        <div style="margin-top:12px">
          <a class="btn btn-outline" href="index.html#book">Go to Booking Calendar</a>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 .25rem">Your Appointments</h3>
        <p class="muted">We’ll add upcoming visits here soon. For now, use the booking calendar to manage dates.</p>
        <div style="margin-top:10px">
          <a class="btn btn-outline" href="index.html#book">Manage bookings</a>
        </div>
      </div>
    </section>
  </div>

  <!-- Auth gate + sign out -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const who = document.getElementById('whoami');
    const greet = document.getElementById('greeting');
    const btnOut = document.getElementById('signOutBtn');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        const next = encodeURIComponent('client.html');
        location.href = `login.html?next=${next}`;
        return;
      }
      try {
        const snap = await getDoc(doc(db,'users',user.uid));
        const prof = snap.exists() ? snap.data() : {};
        const name = prof.displayName || user.displayName || user.email || 'Client';
        who.textContent = user.email || name;
        greet.textContent = `Hi ${name.split(' ')[0]}, pick a service to get an instant quote.`;
      } catch {
        who.textContent = user.email || user.uid;
      }
    });

    btnOut.addEventListener('click', async (e) => {
      e.preventDefault();
      await signOut(auth);
      location.href = 'index.html';
    });
  </script>

  <!-- === Finishing Touch — AI Concierge Chat (page-aware, guard against double init) === -->
  <div id="ftt-chat-launcher" aria-label="Open chat" role="button">💬</div>

  <div id="ftt-chat" aria-live="polite" aria-label="Chat window" hidden>
    <div class="ftt-chat-header">
      <div>
        <div class="ftt-title">The Finishing Touch</div>
        <div class="ftt-subtitle">AI Concierge • human on request</div>
      </div>
      <button class="ftt-close" aria-label="Close chat">×</button>
    </div>

    <div id="ftt-thread" class="ftt-thread"></div>

    <form id="ftt-inputbar" class="ftt-inputbar" autocomplete="off">
      <input id="ftt-input" name="message" type="text" placeholder="Ask about pricing, availability, services…" aria-label="Type your message" required />
      <button class="ftt-send" type="submit">Send</button>
    </form>

    <div class="ftt-quick">
      <button data-q="pricing">Pricing</button>
      <button data-q="availability">Availability</button>
      <button data-q="services">Services</button>
      <button data-q="book">Book now</button>
      <button data-q="human">Talk to a person</button>
      <button data-q="help">Help me choose</button>
    </div>
  </div>

  <script>
    (function(){
      if (window.__FTT_CHAT_READY__) return; // guard so we don't double-init
      window.__FTT_CHAT_READY__ = true;

      const FTT_CFG = {
        timezone: "America/Chicago",
        // Where "Start Intake" should point when chat answers
        intakeAnchor: "intake-cleaning.html",
        bookUrl: "https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9",
        email: "contact.thefinishingtouch.tx@gmail.com",
        messengerDeepLink: "https://m.me/thefinishingtouch.tx",
        hours: { days:[1,2,3,4,5], open:"09:00", close:"17:00" },
      };

      const el = {
        launcher: document.getElementById("ftt-chat-launcher"),
        panel: document.getElementById("ftt-chat"),
        thread: document.getElementById("ftt-thread"),
      };

      function isWithinBusinessHours(){
        try{
          const now = new Date();
          const opt = { timeZone: FTT_CFG.timezone, hour12:false, weekday:"short", hour:"2-digit", minute:"2-digit" };
          const parts = new Intl.DateTimeFormat("en-US",opt).formatToParts(now);
          const hh=+(parts.find(p=>p.type==="hour")?.value||"0");
          const mm=+(parts.find(p=>p.type==="minute")?.value||"0");
          const wdShort=parts.find(p=>p.type==="weekday")?.value||"";
          const map={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};
          const wd = map[wdShort] ?? now.getDay();
          const [oH,oM]=FTT_CFG.hours.open.split(":").map(Number);
          const [cH,cM]=FTT_CFG.hours.close.split(":").map(Number);
          const after=(hh>oH)||(hh===oH&&mm>=oM), before=(hh<cH)||(hh===cH&&mm<=cM);
          return FTT_CFG.hours.days.includes(wd) && after && before;
        }catch{return false;}
      }

      function addMsg(html, who="bot"){
        const b=document.createElement("div");
        b.className=`ftt-bubble ${who}`; b.innerHTML=html;
        el.thread.appendChild(b); el.thread.scrollTop=el.thread.scrollHeight;
      }

      function greet(){
        addMsg("Hi! I’m your AI concierge. Ask me about pricing, availability, or services. Say “human” any time and I’ll route you.","bot");
      }

      function detectIntent(text){
        const t=text.toLowerCase();
        if (/(human|person|agent|representative|someone|call|talk to)/.test(t)) return "human";
        if (/(price|pricing|cost|rate|how much)/.test(t)) return "pricing";
        if (/(avail|slot|appointment|when|schedule|open)/.test(t)) return "availability";
        if (/(service|decor|holiday|organize|clean|what do you do)/.test(t)) return "services";
        if (/(book|booking|schedule now)/.test(t)) return "book";
        if (/(which|help choose|recommend|not sure|what should i (pick|choose)|suggest)/.test(t)) return "recommend";
        return "fallback";
      }

      function answer(intent){
        const hoursNote = isWithinBusinessHours()
          ? "We’re online now—ask me anything or say “human” to chat with a person."
          : "We’re offline at the moment, but I can still help or route your message.";
        const intakeLink = `<a href="${FTT_CFG.intakeAnchor}">Start Intake</a>`;
        const bookLink = `<a href="${FTT_CFG.bookUrl}" target="_blank" rel="noopener">Book now</a>`;
        switch(intent){
          case "pricing":
            return [
              "Get an instant quote by starting an intake. Your estimate shows on the page and is emailed to you.",
              intakeLink + " • or " + bookLink + " to see the calendar.",
              hoursNote
            ].join("<br>");
          case "availability":
            return ["Availability is live in Square.", bookLink + " to see current openings, or " + intakeLink + " first.", hoursNote].join("<br>");
          case "services":
            return [
              "We offer Cleaning, Organizing, Interior Decorating, and Indoor Holiday installs.",
              "Each intake gives you a tailored ballpark estimate.",
              "Start here: " + intakeLink + " • Or jump to " + bookLink + "."
            ].join("<br>");
          case "book": return "Perfect—" + bookLink + " (Square opens in a new tab), or " + intakeLink + " for a tailored estimate first.";
          case "human":
            return isWithinBusinessHours()
              ? `Absolutely. Tap <a href="${FTT_CFG.messengerDeepLink}" target="_blank" rel="noopener">Message us on Facebook</a> for fastest response.`
              : `We’re offline. You can still <a href="${FTT_CFG.messengerDeepLink}" target="_blank" rel="noopener">message us on Facebook</a> or email <a href="mailto:${FTT_CFG.email}">${FTT_CFG.email}</a> and we’ll reply ASAP.`;
          case "recommend":
            return [
              "<strong>Happy to help you choose!</strong>",
              "Small: single area. Medium: a room plus accents. Large: multiple areas or deep setup.",
              `Ready to book? ${bookLink} (opens in a new tab). Or ${intakeLink} first.`
            ].join("<br>");
          default:
            return ["I can help with pricing, availability, and services.", "Try “what’s your pricing?” or “do you have Friday slots?”", "Say “human” any time to talk to a person."].join("<br>");
        }
      }

      function init(){
        const launcher=document.getElementById("ftt-chat-launcher");
        const panel=document.getElementById("ftt-chat");
        const closeBtn=document.querySelector(".ftt-close");
        const input=document.getElementById("ftt-input");
        const form=document.getElementById("ftt-inputbar");
        const quick=document.querySelector(".ftt-quick");

        launcher.addEventListener("click", ()=>{
          panel.hidden=false;
          if (!document.getElementById("ftt-thread").dataset.greeted){
            greet(); document.getElementById("ftt-thread").dataset.greeted="1";
          }
          input.focus();
        });
        closeBtn.addEventListener("click", ()=>{ panel.hidden=true; });
        form.addEventListener("submit",(e)=>{
          e.preventDefault();
          const t=input.value.trim(); if(!t) return;
          addMsg(t,"me"); input.value="";
          setTimeout(()=> addMsg(answer(detectIntent(t)),"bot"), 200);
        });
        quick.addEventListener("click",(e)=>{
          if (e.target.matches("button[data-q]")){
            const map={pricing:"pricing",availability:"availability",services:"services",book:"book",human:"human",help:"recommend"};
            const intent=map[e.target.getAttribute("data-q")]||"fallback";
            addMsg(e.target.textContent,"me"); setTimeout(()=>addMsg(answer(intent),"bot"),200);
          }
        });
      }
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>