<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Client Portal ‚Äì The Finishing Touch</title>

  <!-- Fonts & Site CSS (reuse home styling) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Manrope:wght@400;500;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=9"/>

  <style>
    html{scroll-behavior:smooth}
    body{background:#fbf8f4}
    .container{width:min(1180px,94%);margin-inline:auto}

    /* Header: match index.html */
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:10px 0}
    .main-nav{display:flex;gap:10px;flex-wrap:wrap}
    .main-nav a{white-space:nowrap}

    /* Hero: same look, slightly shorter */
    .hero{position:relative}
    .hero-media img{width:100%;height:clamp(260px,36vw,420px);object-fit:cover;object-position:center;display:block}
    .hero-scrim{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.35))}
    .hero-content{position:absolute;inset:0;display:grid;align-content:center}
    .hero-content .script-kicker,.hero-content .hero-title,.hero-content .hero-sub{max-width:min(820px,92%);color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.25)}

    /* Sections & cards */
    .section{padding:20px 0 10px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;align-items:stretch}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);display:flex;flex-direction:column;gap:8px;justify-content:center}
    .card h3{margin:.25rem 0 .15rem}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:.95rem;opacity:.9}
    .small{font-size:.9rem;opacity:.85}
    .hint{font-size:.92rem;opacity:.9}

    /* Quick Actions */
    .qa-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px}
    .inline-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .inline-actions select{border:1px solid #e3d9ce;border-radius:10px;padding:.55rem .7rem;background:#fffdfb}

    .btn{display:inline-block;padding:.55rem .85rem;border-radius:999px;font-weight:800;text-decoration:none;cursor:pointer}
    .btn-outline{border:1.5px solid #2e2a27;background:#fff;color:#2e2a27}
    .btn-solid{background:#d2bda9;color:#2a2624;border:0}

    /* Job list */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .empty{background:#fff;border:1px dashed #e3d9ce;border-radius:16px;padding:22px;text-align:center}

    /* Footer spacer */
    .spacer{height:24px}

    /* Chat z-index safety */
    #ftt-chat-launcher,#ftt-chat{z-index:9999}
  </style>
</head>
<body class="page-client">
  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <span class="vase-logo" aria-hidden="true"></span>
        <span class="brand-name">The Finishing Touch</span>
      </div>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="index.html#services">Services</a>
        <a href="index.html#about">About</a>
        <a href="contact.html">Contact</a>
        <a class="btn btn-outline" id="btnSignOut" href="#">Sign out</a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="hero-media">
      <img src="bed-banner.png" alt="Styled bedroom by The Finishing Touch">
      <div class="hero-scrim"></div>
    </div>
    <div class="container hero-content">
      <p class="script-kicker">Welcome back</p>
      <h1 class="hero-title" id="heroName">Your Client Portal</h1>
      <p class="hero-sub">Start a new intake, check status, and manage bookings‚Äîall in one place.</p>
    </div>
  </section>

  <!-- Quick Actions -->
  <section class="section">
    <div class="container">
      <div class="qa-grid">
        <article class="card">
          <h3>Start a New Intake</h3>
          <p class="small">Pick a service to get an instant ballpark estimate, then book.</p>
          <div class="inline-actions">
            <select id="qaService">
              <option value="intake-cleaning.html">Cleaning</option>
              <option value="intake-organizing.html">Organizing</option>
              <option value="intake-decor.html">Interior Decorating</option>
              <option value="intake-holiday.html">Holiday & Events</option>
            </select>
            <a id="qaGo" class="btn btn-solid" href="#">Go</a>
          </div>
          <p class="hint">We‚Äôll email you a copy of your estimate on the intake page.</p>
        </article>

        <article class="card">
          <h3>Book on Square</h3>
          <p class="small">See live availability and schedule instantly.</p>
          <a class="btn btn-outline" target="_blank" rel="noopener" href="https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9">Open Calendar</a>
        </article>

        <article class="card">
          <h3>My Estimates</h3>
          <p class="small">Review estimates we‚Äôve shared or saved with your account.</p>
          <a class="btn btn-outline" href="#my-jobs">View</a>
        </article>

        <article class="card">
          <h3>Support</h3>
          <p class="small">Questions about your booking or scope?</p>
          <div class="inline-actions">
            <a class="btn btn-outline" target="_blank" rel="noopener" href="https://m.me/thefinishingtouch.tx">Message us</a>
            <a class="btn btn-outline" href="mailto:contact.thefinishingtouch.tx@gmail.com">Email</a>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- My Jobs -->
  <section id="my-jobs" class="section">
    <div class="container">
      <h2 style="margin:8px 4px 10px">My Jobs</h2>
      <div id="jobList" class="grid" aria-live="polite"></div>
    </div>
  </section>

  <div class="spacer"></div>

  <!-- Firebase + logic -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { collection, query, where, orderBy, onSnapshot, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const el = {
      heroName: document.getElementById('heroName'),
      jobList: document.getElementById('jobList'),
      signOut: document.getElementById('btnSignOut'),
      qaService: document.getElementById('qaService'),
      qaGo: document.getElementById('qaGo')
    };

    const money = (n)=> (n!=null && !isNaN(Number(n))) ? `$${Math.round(Number(n))}` : "";
    const cap = (s)=> s ? s[0].toUpperCase()+s.slice(1) : "";

    // Sign out
    el.signOut.addEventListener('click', async (e)=>{ e.preventDefault(); await signOut(auth); location.href = "index.html"; });

    // ‚ÄúGo‚Äù button for quick intake
    const setHref = ()=> { el.qaGo.href = el.qaService.value; };
    el.qaService.addEventListener('change', setHref); setHref();

    onAuthStateChanged(auth, async (user) => {
      if (!user){ location.href = "login.html?next=" + encodeURIComponent("client.html"); return; }

      // Friendly greeting
      try {
        const snap = await getDoc(doc(db,"users",user.uid));
        const name = snap.exists() ? (snap.data().fullName || snap.data().displayName) : "";
        el.heroName.textContent = name ? `Hi, ${name.split(" ")[0]}` : "Your Client Portal";
      } catch { /* noop */ }

      // Jobs owned by client
      const q = query(collection(db,"jobs"), where("clientId","==",user.uid), orderBy("createdAt","desc"));
      onSnapshot(q, (snap) => {
        if (snap.empty){
          el.jobList.innerHTML = `
            <div class="empty">
              No jobs yet. Start a new intake above to get a quote and book your time.
            </div>`;
          return;
        }
        el.jobList.innerHTML = snap.docs.map(d => {
          const j = { id:d.id, ...d.data() };
          const title = cap(j.serviceType || "Job");
          const when  = j.window || "";
          const hours = j.estimatedTeamHours || j.teamHours || "";
          const price = (j.flatRate!=null) ? `¬∑ Est: <strong>${money(j.flatRate)}</strong>` : "";
          const area  = j.zip || j.area || "";
          const status = j.status || "";

          return `
            <article class="card">
              <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px">
                <strong>${title}</strong>
                <span class="small">Status: <code>${status}</code></span>
              </div>
              <div class="meta">
                ${area?`<span>üìç ${area}</span>`:""}
                ${when?`<span>üóìÔ∏è ${when}</span>`:""}
                ${hours?`<span>‚è±Ô∏è ${hours} hrs</span>`:""}
                ${price}
              </div>
              ${j.summary ? `<div>${j.summary}</div>` : ""}
              ${j.notes   ? `<div class="small" style="opacity:.85">${j.notes}</div>` : ""}
            </article>
          `;
        }).join("");
      });
    });
  </script>

  <!-- === Finishing Touch ‚Äî AI Concierge Chat (guarded) === -->
  <style>
    #ftt-chat-launcher{position:fixed;right:18px;bottom:18px;width:54px;height:54px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:#2e2a27;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 10px 28px rgba(0,0,0,.18)}
    #ftt-chat{position:fixed;right:18px;bottom:84px;width:340px;max-width:calc(100vw - 36px);background:#fff;border:1px solid #e8ddd1;border-radius:14px;box-shadow:0 14px 40px rgba(0,0,0,.18);display:none;font-family:Manrope,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .ftt-chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #f0e9e2;background:#fffdfb}
    .ftt-title{font-weight:800;color:#2e2a27}.ftt-subtitle{font-size:.9rem;color:#7b746e}
    .ftt-close{border:0;background:#fff;font-size:22px;cursor:pointer;line-height:1}
    .ftt-thread{height:300px;overflow:auto;padding:12px}
    .ftt-bubble{max-width:85%;padding:10px 12px;border-radius:12px;margin:8px 0;line-height:1.3}
    .ftt-bubble.bot{background:#fbf8f4;color:#2e2a27}.ftt-bubble.me{background:#2e2a27;color:#fff;margin-left:auto}
    .ftt-inputbar{display:flex;gap:8px;border-top:1px solid #f0e9e2;padding:10px}
    .ftt-inputbar input{flex:1;border:1px solid #e3d9ce;border-radius:999px;padding:.65rem .9rem;background:#fffdfb}
    .ftt-inputbar button{border:0;border-radius:999px;padding:.65rem .95rem;font-weight:800;background:#d2bda9;color:#2a2624;cursor:pointer}
    .ftt-quick{display:flex;flex-wrap:wrap;gap:6px;padding:10px;border-top:1px solid #f0e9e2}
    .ftt-quick button{border:1px solid #e3d9ce;background:#fff;border-radius:999px;padding:.35rem .7rem;cursor:pointer;font-weight:700}
    @media(max-width:420px){.ftt-thread{height:48vh}}
  </style>

  <div id="ftt-chat-launcher" aria-label="Open chat" role="button">üí¨</div>
  <div id="ftt-chat" aria-live="polite" aria-label="Chat window">
    <div class="ftt-chat-header">
      <div>
        <div class="ftt-title">The Finishing Touch</div>
        <div class="ftt-subtitle">AI Concierge ‚Ä¢ human on request</div>
      </div>
      <button class="ftt-close" aria-label="Close chat">√ó</button>
    </div>
    <div id="ftt-thread" class="ftt-thread"></div>
    <form id="ftt-inputbar" class="ftt-inputbar" autocomplete="off">
      <input id="ftt-input" name="message" type="text" placeholder="Ask about pricing, availability, services‚Ä¶" aria-label="Type your message" required />
      <button class="ftt-send" type="submit">Send</button>
    </form>
    <div class="ftt-quick">
      <button data-q="pricing">Pricing</button>
      <button data-q="availability">Availability</button>
      <button data-q="services">Services</button>
      <button data-q="book">Book now</button>
      <button data-q="human">Talk to a person</button>
      <button data-q="help">Help me choose</button>
    </div>
  </div>

  <script>
    (function(){
      if (window.__FTT_CHAT_READY__) return;
      window.__FTT_CHAT_READY__ = true;

      const CFG = {
        timezone:"America/Chicago",
        intakeAnchor:"intake-cleaning.html",
        bookUrl:"https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9",
        email:"contact.thefinishingtouch.tx@gmail.com",
        messenger:"https://m.me/thefinishingtouch.tx",
        hours:{days:[1,2,3,4,5],open:"09:00",close:"17:00"}
      };

      const panel=document.getElementById("ftt-chat");
      const thread=document.getElementById("ftt-thread");
      const input=document.getElementById("ftt-input");
      const form=document.getElementById("ftt-inputbar");
      const quick=document.querySelector(".ftt-quick");
      const closeBtn=document.querySelector(".ftt-close");
      const launcher=document.getElementById("ftt-chat-launcher");

      function add(html,who="bot"){const b=document.createElement("div");b.className=`ftt-bubble ${who}`;b.innerHTML=html;thread.appendChild(b);thread.scrollTop=thread.scrollHeight;}
      function greet(){add("Hi! I‚Äôm your AI concierge. Ask me about pricing, availability, or services. Say ‚Äúhuman‚Äù anytime.","bot");}
      function openPanel(){panel.style.display="block"; if(!thread.dataset.greeted){greet();thread.dataset.greeted="1";} input.focus();}
      function closePanel(){panel.style.display="none";}
      function hoursNow(){
        try{
          const now=new Date();
          const opt={timeZone:CFG.timezone,hour12:false,weekday:"short",hour:"2-digit",minute:"2-digit"};
          const parts=new Intl.DateTimeFormat("en-US",opt).formatToParts(now);
          const hh=+(parts.find(p=>p.type==="hour")?.value||"0");
          const mm=+(parts.find(p=>p.type==="minute")?.value||"0");
          const dShort=parts.find(p=>p.type==="weekday")?.value||"";
          const map={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};
          const wd=map[dShort] ?? now.getDay();
          const [oH,oM]=CFG.hours.open.split(":").map(Number);
          const [cH,cM]=CFG.hours.close.split(":").map(Number);
          const after=(hh>oH)||(hh===oH&&mm>=oM), before=(hh<cH)||(hh===cH&&mm<=cM);
          return CFG.hours.days.includes(wd)&&after&&before;
        }catch{return false;}
      }
      function detect(t){
        t=t.toLowerCase();
        if(/human|person|agent|representative|call|talk/.test(t))return"human";
        if(/price|pricing|cost|rate|how much/.test(t))return"pricing";
        if(/avail|slot|appointment|when|schedule|open/.test(t))return"availability";
        if(/service|decor|holiday|organize|clean|what do you do/.test(t))return"services";
        if(/book|booking|schedule now/.test(t))return"book";
        if(/which|help|recommend|not sure|choose/.test(t))return"recommend";
        return"fallback";
      }
      function answer(intent){
        const intake=`<a href="${CFG.intakeAnchor}">Start Intake</a>`;
        const book=`<a href="${CFG.bookUrl}" target="_blank" rel="noopener">Book now</a>`;
        switch(intent){
          case"pricing":return["Get an instant quote by starting an intake.",intake+" ‚Ä¢ or "+book,"We‚Äôll email you a copy."].join("<br>");
          case"availability":return["Availability is live in Square.",book+" to see current openings, or "+intake+" first."].join("<br>");
          case"services":return["We offer Cleaning, Organizing, Interior Decorating, and Indoor Holiday installs.","Each intake gives a tailored ballpark.","Start here: "+intake+" ‚Ä¢ Or jump to "+book+"."].join("<br>");
          case"book":return"Perfect‚Äî"+book+" (opens in a new tab), or "+intake+" for a tailored estimate first.";
          case"human":return hoursNow()
            ? `Tap <a href="${CFG.messenger}" target="_blank" rel="noopener">Message us on Facebook</a> for the fastest response.`
            : `We‚Äôre offline; you can still <a href="${CFG.messenger}" target="_blank" rel="noopener">message us on Facebook</a> or email <a href="mailto:${CFG.email}">${CFG.email}</a>.`;
          case"recommend":return["<strong>Happy to help you choose!</strong> Small: single area. Medium: a room plus accents. Large: multiple areas or deep setup.",`Ready to book? ${book} ‚Ä¢ Or ${intake} first.`].join("<br>");
          default:return["I can help with pricing, availability, and services.","Try ‚Äúwhat‚Äôs your pricing?‚Äù or ‚Äúdo you have Friday slots?‚Äù","Say ‚Äúhuman‚Äù to talk to a person."].join("<br>");
        }
      }

      launcher.addEventListener("click",openPanel);
      closeBtn.addEventListener("click",closePanel);
      form.addEventListener("submit",(e)=>{e.preventDefault();const t=input.value.trim();if(!t)return;add(t,"me");input.value="";setTimeout(()=>add(answer(detect(t)),"bot"),120);});
      quick.addEventListener("click",(e)=>{if(e.target.matches("button[data-q]")){const map={pricing:"pricing",availability:"availability",services:"services",book:"book",human:"human",help:"recommend"};const intent=map[e.target.getAttribute("data-q")]||"fallback";add(e.target.textContent,"me");setTimeout(()=>add(answer(intent),"bot"),80);}});
    })();
  </script>

  <!-- Keep Firebase module available for other pages -->
  <script type="module">import { auth } from "./ft-firebase.js";</script>
</body>
</html>
