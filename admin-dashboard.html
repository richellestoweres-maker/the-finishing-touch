<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard ‚Äì The Finishing Touch</title>

  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body{background:var(--paper,#fbf8f4)}
    .portal{width:min(1180px,94%);margin:24px auto 80px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#fff;padding:12px 16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .brand-mini{display:flex;align-items:center;gap:.6rem}
    .brand-mini .vase-logo{width:28px;height:36px;background:url('logo-vase.png') center/contain no-repeat;display:inline-block}
    .rolepill{font-size:.8rem;padding:.2rem .6rem;border-radius:999px;border:1px solid #e3d9ce;background:#fffdfb}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tabbtn{border:1px solid #e3d9ce;background:#fff;color:#2e2a27;border-radius:999px;padding:.55rem .9rem;font-weight:800;cursor:pointer}
    .tabbtn.active{background:var(--accent,#d2bda9);border-color:var(--accent,#d2bda9);color:#2a2624}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .chip{white-space:nowrap;border:1px solid #e3d9ce;background:#fffdfb;color:#2e2a27;border-radius:999px;padding:.35rem .7rem;cursor:pointer;font-weight:700;font-size:.9rem}
    .chip.active{background:#2e2a27;color:#fff;border-color:#2e2a27}
    .search{display:flex;gap:8px}
    .search input{border:1px solid #e3d9ce;border-radius:10px;padding:.55rem .7rem}
    .panels{margin-top:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:14px;display:flex;flex-direction:column;gap:10px}
    .toprow{display:flex;justify-content:space-between;gap:8px;align-items:baseline}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:.92rem;opacity:.9}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-block;padding:.55rem .85rem;border-radius:999px;font-weight:800;text-decoration:none;cursor:pointer}
    .btn-outline{border:1.5px solid #2e2a27;background:#fff;color:#2e2a27}
    .btn-solid{background:var(--accent,#d2bda9);color:#2a2624;border:0}
    .btn-danger{background:#7f1d1d;color:#fff;border:0}
    .empty{background:#fff;border:1px dashed #e3d9ce;border-radius:14px;padding:22px;text-align:center}
    .panel{display:none}
    .panel.active{display:block}
    /* Forms */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid label{display:grid;gap:6px;font-weight:700}
    .form-grid input,.form-grid select,.form-grid textarea{border:1px solid #e3d9ce;border-radius:10px;padding:.6rem .7rem;background:#fffdfb}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{font-size:.92rem;opacity:.9}
    .small{font-size:.9rem;opacity:.85}

    /* Admin helper chat */
    #admin-help-launcher{position:fixed;right:20px;bottom:20px;width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#fff;font-size:22px;box-shadow:0 10px 25px rgba(0,0,0,.25);cursor:pointer;z-index:9999}
    #admin-help{position:fixed;right:20px;bottom:86px;width:360px;max-width:90vw;background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.25);z-index:9999;font-family:system-ui,sans-serif;display:none}
    .ah-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;background:#0f172a;color:#fff}
    .ah-title{font-weight:700}.ah-sub{font-size:12px;opacity:.8}
    .ah-close{background:transparent;border:none;color:#fff;font-size:24px;cursor:pointer}
    .ah-thread{max-height:50vh;overflow:auto;padding:12px;background:#f8fafc;display:flex;flex-direction:column;gap:10px}
    .ah-bubble{max-width:85%;padding:10px 12px;border-radius:12px;line-height:1.35;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .ah-bubble.bot{background:#fff;border:1px solid #eef2f7;align-self:flex-start}
    .ah-bubble.me{background:#0ea5e9;color:#fff;align-self:flex-end}
    .ah-input{display:flex;gap:8px;padding:10px;border-top:1px solid #eef2f7;background:#fff}
    .ah-input input{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:14px}
    .ah-send{background:#0f172a;color:#fff;border:none;border-radius:10px;padding:0 14px;cursor:pointer}
    .ah-quick{display:flex;gap:6px;padding:8px 10px;flex-wrap:wrap;background:#fff;border-top:1px solid #eef2f7}
    .ah-quick button{font-size:12px;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
    @media (max-width:480px){#admin-help{right:10px;bottom:80px;width:92vw}}
    @media (max-width:640px){
      #admin-help{right:0;left:0;bottom:0;width:100vw;height:70vh;border-radius:16px 16px 0 0}
      #admin-help-launcher{right:12px;bottom:12px}
    }
  </style>
</head>
<body>
  <div class="portal">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand-mini">
        <span class="vase-logo" aria-hidden="true"></span>
        <div>
          <div style="font-family:'Playfair Display',serif;line-height:1;color:#2e2a27">The Finishing Touch</div>
          <div class="rolepill">Admin</div>
        </div>
      </div>
      <div class="row">
        <span id="whoami" class="small"></span>
        <a class="btn btn-outline" href="index.html">Home</a>
        <a class="btn btn-outline" href="contractor.html">Contractor view</a>
        <a id="signOutBtn" class="btn btn-outline" href="#">Sign out</a>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Admin sections">
      <button class="tabbtn active" data-tab="open">Open Jobs</button>
      <button class="tabbtn" data-tab="all">All Jobs</button>
      <button class="tabbtn" data-tab="create">Create Job</button>
      <button class="tabbtn" data-tab="contractors">Contractors</button>
      <button class="tabbtn" data-tab="clients">Clients</button>
      <button class="tabbtn" data-tab="apps">Applications</button>
      <button class="tabbtn" data-tab="estimate">Estimate</button>
    </div>

    <!-- Filter/search -->
    <div class="bar">
      <div class="filters" id="filterChips" aria-label="Filter by service type"></div>
      <div class="search">
        <input id="searchBox" type="search" placeholder="Search jobs: zip, summary, notes‚Ä¶" />
        <button id="clearSearch" class="btn btn-outline" type="button">Clear</button>
      </div>
    </div>

    <!-- Panels -->
    <div class="panels">
      <section id="panel-open" class="panel active" aria-live="polite">
        <div id="listOpen" class="grid"></div>
      </section>

      <section id="panel-all" class="panel" aria-live="polite">
        <div id="listAll" class="grid"></div>
      </section>

      <section id="panel-create" class="panel">
        <form id="createForm" class="form-grid" autocomplete="off">
          <label>Service Type
            <select name="serviceType" required>
              <option value="cleaning">Cleaning</option>
              <option value="organizing">Organizing</option>
              <option value="decor">Decor</option>
              <option value="holiday">Holiday</option>
            </select>
          </label>
          <label>Status
            <select name="status">
              <option value="open">open</option>
              <option value="claimed">claimed</option>
              <option value="in_progress">in_progress</option>
              <option value="submitted">submitted</option>
              <option value="approved">approved</option>
              <option value="paid">paid</option>
            </select>
          </label>

          <label>Zip / Area <input name="zip" placeholder="77573" /></label>
          <label>Client UID (optional) <input name="clientId" placeholder="users/{uid}" /></label>
          <label>Contractors Needed <input name="contractorsNeeded" type="number" min="1" value="1" required /></label>
          <label>Flat Rate (shown to client) <input name="flatRate" type="number" min="0" step="1" placeholder="275" /></label>
          <label>Team Hours (est) <input name="estimatedTeamHours" type="number" min="0" step=".5" placeholder="3.5" /></label>

          <!-- NEW: exact scheduling -->
          <label>Service Date <input name="serviceDate" type="date" /></label>
          <label>Arrival Time <input name="serviceTime" type="time" /></label>

          <label>Summary <input name="summary" placeholder="3 bed / 2 bath ‚Äì initial deep clean." /></label>
          <label style="grid-column:1/-1">Notes (internal)
            <textarea name="notes" rows="3" placeholder="entry codes, parking notes ‚Äî keep PII out of top-level doc"></textarea>
          </label>

          <div style="grid-column:1/-1;display:flex;gap:10px;align-items:center">
            <button class="btn btn-solid" type="submit">Create Job</button>
            <span id="createMsg" class="hint"></span>
          </div>
        </form>
        <p class="hint" style="margin-top:10px">Reminder: put any sensitive client details inside <code>jobs/{id}/private/{doc}</code> (admin-only).</p>
      </section>

      <section id="panel-contractors" class="panel" aria-live="polite">
        <div id="listContractors" class="grid"></div>
      </section>

      <section id="panel-clients" class="panel" aria-live="polite">
        <div id="listClients" class="grid"></div>
      </section>

      <section id="panel-apps" class="panel" aria-live="polite">
        <div id="listApps" class="grid"></div>
      </section>

      <!-- Quick Estimate -->
      <section id="panel-estimate" class="panel">
        <div class="card" style="padding:16px">
          <div class="row" style="margin-bottom:10px;gap:10px;align-items:flex-end;flex-wrap:wrap">
            <label>Service
              <select id="estService">
                <option value="cleaning">Cleaning</option>
                <option value="organizing">Organizing</option>
                <option value="decor">Decor</option>
                <option value="holiday">Holiday</option>
              </select>
            </label>
            <button id="estCalcBtn" class="btn btn-solid" type="button">Calculate</button>
            <span class="hint">Basic inputs only‚Äîperfect for phone quotes.</span>
          </div>

          <!-- CLEANING inputs -->
          <div id="estCleaning" class="form-grid" style="margin-top:8px">
            <label>Home Size
              <select id="c_sqft">
                <option>&lt;1000</option>
                <option selected>1000‚Äì2000</option>
                <option>2000‚Äì3000</option>
                <option>3000‚Äì4000</option>
                <option>4000+</option>
              </select>
            </label>
            <label>Service
              <select id="c_service">
                <option>Initial Clean</option>
                <option>Deep Clean</option>
                <option>Move-In / Move-Out Clean</option>
                <option>Airbnb Turnover</option>
                <option>Standard Clean</option>
              </select>
            </label>
            <label>Beds <input id="c_beds" type="number" min="0" value="3"></label>
            <label>Baths <input id="c_baths" type="number" min="0" value="2"></label>
            <label>Other Rooms <input id="c_other" type="number" min="0" value="0"></label>
            <label>Stories
              <select id="c_stories"><option>1</option><option>2</option></select>
            </label>
            <label>Frequency (only affects Standard)
              <select id="c_freq">
                <option value="one-time">one-time</option>
                <option value="weekly">weekly</option>
                <option value="biweekly">biweekly</option>
                <option value="monthly">monthly</option>
              </select>
            </label>
            <label>Add-ons (keywords: oven, fridge, windows, baseboards, laundry)
              <input id="c_addons" placeholder="e.g., oven, windows">
            </label>
          </div>

          <!-- ORGANIZING -->
          <div id="estOrganizing" class="form-grid" style="display:none;margin-top:8px">
            <label>Area
              <select id="o_area">
                <option>Closet</option><option>Kitchen</option><option>Pantry</option>
                <option>Bedroom</option><option>Bathroom</option><option>Garage</option>
                <option>Laundry Room</option><option>Office</option><option>Playroom</option>
                <option>Whole Home (multi-area)</option>
              </select>
            </label>
            <label>Size
              <select id="o_size"><option>Small</option><option selected>Medium</option><option>Large</option></select>
            </label>
            <label># Spaces <input id="o_spaces" type="number" min="1" value="1"></label>
            <label>Complexity
              <select id="o_complex"><option>Light</option><option selected>Moderate</option><option>Heavy</option></select>
            </label>
            <label>Clutter
              <select id="o_clutter"><option>Light</option><option selected>Moderate</option><option>Heavy</option></select>
            </label>
            <label>Decision Speed
              <select id="o_decision"><option>Fast</option><option selected>Average</option><option>Slow</option></select>
            </label>
            <label>Volume
              <select id="o_volume"><option>Low</option><option selected>Medium</option><option>High</option></select>
            </label>
            <label>Containers
              <select id="o_cont"><option>None</option><option>Some (up to 10)</option><option>Many (10+)</option></select>
            </label>
            <label>Add-ons (bins, labels, bins/labels)
              <input id="o_addons" placeholder="e.g., bins/labels">
            </label>
          </div>

          <!-- DECOR -->
          <div id="estDecor" class="form-grid" style="display:none;margin-top:8px">
            <label>Room
              <select id="d_room">
                <option>Living Room</option><option>Bedroom</option><option>Dining Room</option><option>Home Office</option>
                <option>Kitchen / Nook</option><option>Entryway</option><option>Multiple Rooms</option>
              </select>
            </label>
            <label># Rooms <input id="d_count" type="number" min="1" value="1"></label>
            <label>Scope
              <select id="d_scope">
                <option>Light refresh (styling)</option>
                <option>Refresh + small sourcing</option>
                <option>Full design (sourcing + install)</option>
              </select>
            </label>
            <label>Type
              <select id="d_type">
                <option>Interior Decorating (refresh)</option>
                <option>Staging ‚Äî Occupied</option>
                <option>Staging ‚Äî Vacant</option>
              </select>
            </label>
            <label>Add-ons (moodboard, sourcing, shopping, install, window treatments, art hanging)
              <input id="d_addons" placeholder="e.g., install, shopping">
            </label>
          </div>

          <!-- HOLIDAY -->
          <div id="estHoliday" class="form-grid" style="display:none;margin-top:8px">
            <label>Occasion / Holiday
              <input id="h_occasion" list="occasionOptions" placeholder="e.g., Christmas, Birthday, Thanksgiving">
              <datalist id="occasionOptions">
                <option value="New Year‚Äôs Day"></option><option value="Valentine‚Äôs Day"></option><option value="Galentine‚Äôs Party"></option>
                <option value="St. Patrick‚Äôs Day"></option><option value="Easter"></option><option value="Mother‚Äôs Day"></option><option value="Graduation"></option>
                <option value="Memorial Day"></option><option value="Juneteenth"></option><option value="4th of July"></option><option value="Back to School"></option><option value="Labor Day"></option>
                <option value="Halloween"></option><option value="Thanksgiving"></option><option value="Hanukkah"></option><option value="Christmas"></option><option value="New Year‚Äôs Eve"></option>
                <option value="Birthday"></option><option value="Baby Shower"></option><option value="Bridal Shower"></option><option value="Engagement"></option><option value="Anniversary"></option><option value="Retirement"></option><option value="Game Day / Super Bowl"></option><option value="Custom"></option>
              </datalist>
            </label>
            <label># Trees <input id="h_trees" type="number" min="0" value="1"></label>
            <label>Tallest Tree
              <select id="h_tallest"><option>‚â§6 ft</option><option selected>7‚Äì8 ft</option><option>9‚Äì10 ft</option><option>11‚Äì12+ ft</option></select>
            </label>
            <label>Tree Style
              <select id="h_style"><option>Ready: ornaments & lights on hand</option><option>Needs ribbon/theme refresh</option><option>Full design + sourcing</option></select>
            </label>
            <label>Ribbon? <select id="h_ribbon"><option>No</option><option>Yes</option></select></label>
            <label>Wreaths <input id="h_wreaths" type="number" min="0" value="0"></label>
            <label>Garland Sections <input id="h_garland" type="number" min="0" value="0"></label>
            <label>Stair Sections <input id="h_stairs" type="number" min="0" value="0"></label>
            <label>Mantle? <select id="h_mantle"><option>No</option><option>Yes</option></select></label>
            <label>Tablescapes <input id="h_tables" type="number" min="0" value="0"></label>
            <label>Storage
              <select id="h_storage"><option>Garage/closet (easy)</option><option>Attic (ladder)</option><option>Offsite pickup</option></select>
            </label>
            <label>Shopping Trips
              <select id="h_trips"><option>0</option><option>1</option><option>2</option><option>3+</option></select>
            </label>
            <label>Include Teardown? <select id="h_teardown"><option>Yes</option><option>No</option></select></label>
          </div>

          <div id="estResult" class="card" style="margin-top:14px;background:#fffdfb;border:1px solid #e3d9ce">
            <div id="estOut" class="small">Fill fields and hit ‚ÄúCalculate‚Äù.</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Admin Helper Chat (UI) -->
  <div id="admin-help-launcher" aria-label="Open admin help">‚ùì</div>
  <div id="admin-help" aria-live="polite" aria-label="Admin help chat">
    <div class="ah-head">
      <div>
        <div class="ah-title">Admin Help</div>
        <div class="ah-sub">Short answers + quick links</div>
      </div>
      <button class="ah-close" aria-label="Close">√ó</button>
    </div>
    <div id="ah-thread" class="ah-thread"></div>
    <div class="ah-quick">
      <button data-q="how quote">How do I quote?</button>
      <button data-q="organizing">Organizing time?</button>
      <button data-q="assign">Assign a job</button>
      <button data-q="status">Statuses</button>
      <button data-q="booking">Booking link</button>
      <button data-q="gameday">Game Day fields</button>
      <button data-q="birthday">Birthday fields</button>
      <button data-q="christmas">Christmas fields</button>
      <button data-q="holiday">Holiday cheat sheet</button>
    </div>
    <div class="ah-input">
      <input id="ah-input" type="text" placeholder="Ask a quick question‚Ä¶" />
      <button class="ah-send" id="ah-send">Send</button>
    </div>
  </div>

  <!-- Pricing calculators (exposes calc* fns used by estimator) -->
  <script src="script.js" defer></script>

  <!-- App logic -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      collection, query, where, orderBy, onSnapshot, limit,
      doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc,
      serverTimestamp, runTransaction, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const whoami = document.getElementById('whoami');
    const btnOut = document.getElementById('signOutBtn');

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html?next=" + encodeURIComponent("admin-dashboard.html"); return; }
      whoami.textContent = user.email || user.uid;

      const roleSnap = await getDoc(doc(db, "users", user.uid));
      const role = (roleSnap.exists() ? (roleSnap.data().role || "") : "").toLowerCase();
      if (role !== "admin") { location.href = "contractor.html"; return; }
      init();
    });

    btnOut.addEventListener('click', async (e) => {
      e.preventDefault(); await signOut(auth); location.href = "index.html";
    });

    const ALL_TYPES = ["cleaning","organizing","decor","holiday"];
    const chipsWrap = document.getElementById('filterChips');
    const searchBox = document.getElementById('searchBox');
    const clearSearch = document.getElementById('clearSearch');
    let activeType = "all";
    let searchTerm = "";

    function renderChips(){
      chipsWrap.innerHTML = "";
      ["all", ...ALL_TYPES].forEach(t => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip" + (t===activeType ? " active" : "");
        b.textContent = t==="all" ? "All" : (t[0].toUpperCase()+t.slice(1));
        b.addEventListener("click", () => { activeType = t; drawOpen(lastOpen); drawAll(lastAll); });
        chipsWrap.appendChild(b);
      });
    }

    const tabs = Array.from(document.querySelectorAll(".tabbtn"));
    const panels = Array.from(document.querySelectorAll(".panel"));
    function setTab(key){
      tabs.forEach(t => t.classList.toggle("active", t.dataset.tab===key));
      panels.forEach(p => p.classList.toggle("active", p.id === "panel-"+key));
    }
    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    searchBox.addEventListener("input", () => { searchTerm = searchBox.value.trim().toLowerCase(); drawOpen(lastOpen); drawAll(lastAll); });
    clearSearch.addEventListener("click", () => { searchBox.value=""; searchTerm=""; drawOpen(lastOpen); drawAll(lastAll); });

    const elOpen = document.getElementById('listOpen');
    const elAll  = document.getElementById('listAll');
    const elCons = document.getElementById('listContractors');
    const elClients = document.getElementById('listClients');
    const elApps = document.getElementById('listApps');

    let unsubOpen=null, unsubAll=null, unsubCons=null, unsubClients=null, unsubApps=null;
    let lastOpen=[], lastAll=[];

    function cap(s){ return s ? (s[0].toUpperCase()+s.slice(1)) : ""; }
    function fmt(n){ return (n!=null && !isNaN(Number(n))) ? `$${Math.round(Number(n))}` : ""; }
    function matchFilters(j){
      const type = (j.serviceType||"").toLowerCase();
      const okType = (activeType==="all") || (type===activeType);
      if (!okType) return false;
      if (!searchTerm) return true;
      const hay = JSON.stringify(j).toLowerCase();
      return hay.includes(searchTerm);
    }
    function slots(j){
      const need = Number(j.contractorsNeeded || 1);
      const have = Array.isArray(j.contractorIds) ? j.contractorIds.length : (j.contractorId ? 1 : 0);
      const left = Math.max(0, need - have);
      return {need,have,left};
    }
    function fmtDate(ts){
      if (!ts?.toDate) return {date:"", time:""};
      const d=ts.toDate();
      return {
        date: d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'}),
        time: d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'})
      };
    }

    function jobCard(j){
      const {need, have, left} = slots(j);
      const zip = j.zip || j.area || j.city || "";
      const dt = fmtDate(j.serviceDate);
      const title = cap(j.serviceType||"job");
      const payLine = j.flatRate!=null ? `<span>Client est: <strong>${fmt(j.flatRate)}</strong></span>` : "";
      const leftTxt = need>1 ? `‚Ä¢ ${left} of ${need} slots left` : "";

      return `
        <div class="card" data-id="${j.id}">
          <div class="toprow">
            <strong>${title}</strong>
            <span class="small">Status: <code>${j.status||''}</code></span>
          </div>
          <div class="meta">
            ${zip?`<span>üìç ${zip}</span>`:""}
            ${dt.date?`<span>üóìÔ∏è ${dt.date}</span>`:""}
            ${dt.time?`<span>üïò ${dt.time}</span>`:""}
            ${j.estimatedTeamHours?`<span>‚è±Ô∏è ${j.estimatedTeamHours} hrs</span>`:""}
            ${leftTxt}
            ${payLine}
          </div>
          ${j.summary?`<div>${j.summary}</div>`:""}
          ${j.notes?`<div class="small" style="opacity:.8">${j.notes}</div>`:""}

          <div class="actions">
            <button class="btn btn-outline" data-act="assign-self">Assign me</button>
            <button class="btn btn-outline" data-act="assign-by-email">Assign by email</button>
            <button class="btn btn-outline" data-act="unassign">Unassign</button>
            <select class="btn" data-act="status">
              ${["open","claimed","in_progress","submitted","approved","paid"].map(s=>`<option value="${s}" ${j.status===s?"selected":""}>${s}</option>`).join("")}
            </select>
            <button class="btn btn-outline" data-act="private">Private note</button>
            <button class="btn btn-danger" data-act="delete">Delete</button>
          </div>
        </div>
      `;
    }

    function drawOpen(list){
      const filtered = list.filter(matchFilters);
      elOpen.innerHTML = filtered.length ? filtered.map(jobCard).join("") : `<div class="empty">No open jobs match.</div>`;
      hookJobActions(elOpen, filtered);
    }
    function drawAll(list){
      const filtered = list.filter(matchFilters);
      elAll.innerHTML = filtered.length ? filtered.map(jobCard).join("") : `<div class="empty">No jobs match.</div>`;
      hookJobActions(elAll, filtered);
    }

    function drawPeople(container, people, role){
      if (!people.length){ container.innerHTML = `<div class="empty">No ${role}s found.</div>`; return; }
      container.innerHTML = people.map(p=>`
        <div class="card">
          <div class="toprow">
            <strong>${p.displayName || p.email || p.id}</strong>
            <span class="rolepill">${p.role || ""}</span>
          </div>
          <div class="meta">
            ${p.email?`<span>üìß ${p.email}</span>`:""}
            ${Array.isArray(p.serviceTypes)&&p.serviceTypes.length?`<span>üß∞ ${p.serviceTypes.join(", ")}</span>`:""}
          </div>
          ${role==="contractor"?`<div class="actions">
            <button class="btn btn-outline" data-uid="${p.id}" data-email="${p.email||""}" data-act="copy-id">Copy UID</button>
          </div>`:""}
        </div>
      `).join("");

      container.querySelectorAll('[data-act="copy-id"]').forEach(b=>{
        b.addEventListener("click", async ()=>{
          try{ await navigator.clipboard.writeText(b.dataset.uid); b.textContent="Copied!"; setTimeout(()=>b.textContent="Copy UID",900);}catch{}
        });
      });
    }

    function drawApps(apps){
      const el = document.getElementById('listApps');
      if (!apps.length){ el.innerHTML = `<div class="empty">No pending applications.</div>`; return; }
      el.innerHTML = apps.map(a=>`
        <div class="card">
          <div class="toprow">
            <strong>${a.displayName || a.email || a.id}</strong>
            <span class="rolepill">pending</span>
          </div>
          <div class="meta">
            ${a.email?`<span>üìß ${a.email}</span>`:""}
            ${Array.isArray(a.serviceTypes)&&a.serviceTypes.length?`<span>üß∞ ${a.serviceTypes.join(", ")}</span>`:""}
          </div>
          <div class="actions">
            <button class="btn btn-solid" data-act="approve" data-uid="${a.id}">Approve ‚Üí contractor</button>
            <button class="btn btn-outline" data-act="reject" data-uid="${a.id}">Reject</button>
          </div>
        </div>
      `).join("");

      el.querySelectorAll('[data-act="approve"]').forEach(b=>{
        b.addEventListener("click", async ()=>{
          try{ await updateDoc(doc(db,"users",b.dataset.uid), { role:"contractor", updatedAt: serverTimestamp() }); alert("Approved."); }
          catch(e){ alert("Could not approve."); console.warn(e); }
        });
      });
      el.querySelectorAll('[data-act="reject"]').forEach(b=>{
        b.addEventListener("click", async ()=>{
          try{ await updateDoc(doc(db,"users",b.dataset.uid), { role:"rejected", updatedAt: serverTimestamp() }); alert("Rejected."); }
          catch(e){ alert("Could not reject."); console.warn(e); }
        });
      });
    }

    function hookJobActions(container, jobs){
      const byId = new Map(jobs.map(j=>[j.id,j]));
      container.querySelectorAll(".card .actions").forEach(row=>{
        const id = row.closest(".card").dataset.id;
        const job = byId.get(id);
        if (!job) return;

        row.querySelector('[data-act="assign-self"]')?.addEventListener("click", ()=>assignSelf(id));
        row.querySelector('[data-act="assign-by-email"]')?.addEventListener("click", ()=>assignByEmail(id));
        row.querySelector('[data-act="unassign"]')?.addEventListener("click", ()=>unassign(id));
        row.querySelector('[data-act="private"]')?.addEventListener("click", ()=>editPrivate(id));
        row.querySelector('[data-act="delete"]')?.addEventListener("click", ()=>delJob(id));
        row.querySelector('[data-act="status"]')?.addEventListener("change", (e)=>setStatus(id, e.target.value));
      });
    }

    async function assignSelf(jobId){
      const me = auth.currentUser; if (!me) return;
      try{
        await runTransaction(db, async tx=>{
          const ref=doc(db,"jobs",jobId), snap=await tx.get(ref);
          if (!snap.exists()) throw "Missing";
          const j=snap.data();
          const need=Number(j.contractorsNeeded||1);
          const ids=Array.isArray(j.contractorIds)?[...j.contractorIds]:[];
          if (!ids.includes(me.uid)) ids.push(me.uid);
          const update = {
            contractorIds: ids,
            updatedAt: serverTimestamp(),
            status: (ids.length>=need) ? "claimed" : "open",
            claimedAt: (ids.length>=need) ? serverTimestamp() : j.claimedAt || null
          };
          tx.update(ref, update);
        });
        alert("Assigned.");
      }catch(e){ alert("Could not assign."); console.warn(e); }
    }

    async function assignByEmail(jobId){
      const email = prompt("Enter contractor email to assign:");
      if (!email) return;
      try{
        const q = query(collection(db,"users"), where("email","==", email));
        const snap = await getDocs(q);
        if (snap.empty){ alert("No user with that email."); return; }
        const u = { id: snap.docs[0].id, ...snap.docs[0].data() };
        if ((u.role||"").toLowerCase()==="pending"){ alert("User is pending; approve first."); return; }

        await runTransaction(db, async tx=>{
          const ref=doc(db,"jobs",jobId), ds=await tx.get(ref);
          if (!ds.exists()) throw "Missing";
          const j=ds.data();
          const need=Number(j.contractorsNeeded||1);
          const ids=Array.isArray(j.contractorIds)?[...j.contractorIds]:[];
          if (!ids.includes(u.id)) ids.push(u.id);
          const update = {
            contractorIds: ids,
            updatedAt: serverTimestamp(),
            status: (ids.length>=need) ? "claimed" : "open",
            claimedAt: (ids.length>=need) ? serverTimestamp() : j.claimedAt || null
          };
          tx.update(ref, update);
        });
        alert("Assigned.");
      }catch(e){ alert("Could not assign."); console.warn(e); }
    }

    async function unassign(jobId){
      const who = prompt("Remove which contractor UID? (leave blank to remove the last one)");
      try{
        await runTransaction(db, async tx=>{
          const ref=doc(db,"jobs",jobId), ds=await tx.get(ref);
          if (!ds.exists()) throw "Missing";
          const j=ds.data();
          let ids=Array.isArray(j.contractorIds)?[...j.contractorIds]:[];
          if (!ids.length) return;
          if (who){ ids = ids.filter(x=>x!==who); } else { ids.pop(); }
          tx.update(ref, {
            contractorIds: ids,
            updatedAt: serverTimestamp(),
            status: ids.length ? (j.status||"claimed") : "open"
          });
        });
        alert("Unassigned.");
      }catch(e){ alert("Could not unassign."); console.warn(e); }
    }

    async function setStatus(jobId, status){
      try{ await updateDoc(doc(db,"jobs",jobId), { status, updatedAt: serverTimestamp() }); }
      catch(e){ alert("Could not update status."); console.warn(e); }
    }

    async function delJob(jobId){
      if (!confirm("Delete this job?")) return;
      try{ await deleteDoc(doc(db,"jobs",jobId)); }
      catch(e){ alert("Could not delete."); console.warn(e); }
    }

    async function editPrivate(jobId){
      const note = prompt("Private note (replaces jobs/{id}/private/main.note). Leave blank to clear.");
      try{
        const ref = doc(db, "jobs", jobId, "private", "main");
        await setDoc(ref, { note: (note||""), updatedAt: serverTimestamp() });
        alert("Saved.");
      }catch(e){ alert("Could not save private note."); console.warn(e); }
    }

    function wireCreateForm(){
      const form = document.getElementById('createForm');
      const msg  = document.getElementById('createMsg');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.textContent = "Creating‚Ä¶";

        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());

        // Combine date + time into Firestore Timestamp
        let serviceDateTs = null;
        if (data.serviceDate) {
          const [hh,mm] = (data.serviceTime || "09:00").split(":").map(n=>parseInt(n||0,10));
          const [y,m,d] = data.serviceDate.split("-").map(n=>parseInt(n,10));
          serviceDateTs = Timestamp.fromDate(new Date(y,(m||1)-1,d, hh||9, mm||0,0,0));
        }

        const job = {
          serviceType: (data.serviceType||"").toLowerCase(),
          status: (data.status||"open"),
          zip: (data.zip||"").trim(),
          area: (data.area||"").trim(),
          summary: (data.summary||"").trim(),
          notes: (data.notes||"").trim(),
          flatRate: data.flatRate? Number(data.flatRate) : null,
          estimatedTeamHours: data.estimatedTeamHours? Number(data.estimatedTeamHours) : null,
          contractorsNeeded: Math.max(1, Number(data.contractorsNeeded||1)),
          contractorIds: [],
          clientId: (data.clientId||"").trim(),
          serviceDate: serviceDateTs,                 // <-- exact timestamp (nullable)
          arriveEarlyMinutes: 15,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "America/Chicago",
          reminderFlags: { dayBefore: false, dayOf: false },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        // cleanup empty props
        Object.keys(job).forEach(k=>{ if (job[k]==="" || job[k]==null) delete job[k]; });

        try{
          await addDoc(collection(db,"jobs"), job);
          msg.textContent = "Created ‚úî";
          form.reset();
          setTimeout(()=>msg.textContent="",1200);
          setTab("open");
        }catch(e){
          msg.textContent = "Could not create job.";
          console.warn(e);
        }
      });
    }

    function showEstSection(key){
      document.getElementById('estCleaning').style.display  = (key==='cleaning' ? '' : 'none');
      document.getElementById('estOrganizing').style.display= (key==='organizing' ? '' : 'none');
      document.getElementById('estDecor').style.display     = (key==='decor' ? '' : 'none');
      document.getElementById('estHoliday').style.display   = (key==='holiday' ? '' : 'none');
    }
    function wireEstimator(){
      const svc = document.getElementById('estService');
      const btn = document.getElementById('estCalcBtn');
      const out = document.getElementById('estOut');

      function showEstSectionLocal(key){
        document.getElementById('estCleaning').style.display  = (key==='cleaning' ? '' : 'none');
        document.getElementById('estOrganizing').style.display= (key==='organizing' ? '' : 'none');
        document.getElementById('estDecor').style.display     = (key==='decor' ? '' : 'none');
        document.getElementById('estHoliday').style.display   = (key==='holiday' ? '' : 'none');
      }
      showEstSectionLocal(svc.value);
      svc.addEventListener('change', ()=> showEstSectionLocal(svc.value));

      function labelFromHours(teamHours, occasionLabel){
        const occ = occasionLabel ? ` ‚Äî ${occasionLabel}` : "";
        if (teamHours <= 2.5) return `Holiday & Event (indoor${occ}) ‚Äî Small (‚âà2‚Äì2.5 hr)`;
        if (teamHours <= 4)   return `Holiday & Event (indoor${occ}) ‚Äî Medium (‚âà3‚Äì4 hr)`;
        if (teamHours <= 6)   return `Holiday & Event (indoor${occ}) ‚Äî Large (‚âà5‚Äì6 hr)`;
        return `Holiday & Event (indoor${occ}) ‚Äî XL (6.5+ hr)`;
      }

      btn.addEventListener('click', () => {
        const type = svc.value;
        try{
          if (type === 'cleaning'){
            const data = {
              sqft: document.getElementById('c_sqft').value,
              service: document.getElementById('c_service').value,
              beds: document.getElementById('c_beds').value,
              baths: document.getElementById('c_baths').value,
              other_rooms: document.getElementById('c_other').value,
              stories: document.getElementById('c_stories').value,
              frequency: document.getElementById('c_freq').value,
              addons: document.getElementById('c_addons').value
            };
            const price = (window.calcCleaning ? calcCleaning(data) : 0);
            const { teamHours } = (window.estimateHoursCleaning ? estimateHoursCleaning(data) : {teamHours:0});
            const hint = (window.cleaningHint ? cleaningHint(data, teamHours) : '');
            out.innerHTML = `Estimate: <strong>$${price}</strong><br><span class="hint">${hint}</span>`;
            return;
          }

          if (type === 'organizing'){
            const data = {
              org_area: document.getElementById('o_area').value,
              org_size: document.getElementById('o_size').value,
              spaces: document.getElementById('o_spaces').value,
              complexity: document.getElementById('o_complex').value,
              org_clutter: document.getElementById('o_clutter').value,
              org_decision_speed: document.getElementById('o_decision').value,
              org_volume: document.getElementById('o_volume').value,
              org_containers: document.getElementById('o_cont').value,
              addons: document.getElementById('o_addons').value
            };
            const price = (window.calcOrganizing ? calcOrganizing(data) : 0);
            const { teamHours } = (window.estimateHoursOrganizing ? estimateHoursOrganizing(data) : {teamHours:0});
            const hint = (window.organizingHint ? organizingHint(data, teamHours) : '');
            out.innerHTML = `Estimate: <strong>$${price}</strong><br><span class="hint">${hint}</span>`;
            return;
          }

          if (type === 'decor'){
            const data = {
              room: document.getElementById('d_room').value,
              count: document.getElementById('d_count').value,
              decor_scope: document.getElementById('d_scope').value,
              decor_type: document.getElementById('d_type').value,
              addons: document.getElementById('d_addons').value
            };
            const price = (window.calcDecor ? calcDecor(data) : 0);
            const { teamHours } = (window.estimateHoursDecor ? estimateHoursDecor(data) : {teamHours:0});
            const hint = (window.decorHint ? decorHint(data, teamHours) : '');
            out.innerHTML = `Estimate: <strong>$${price}</strong><br><span class="hint">${hint}</span>`;
            return;
          }

          if (type === 'holiday'){
            const occasion = (document.getElementById('h_occasion')?.value || '').trim();
            const data = {
              occasion,
              trees: document.getElementById('h_trees').value,
              tallest: document.getElementById('h_tallest').value,
              tree_style: document.getElementById('h_style').value,
              tree_ribbon: document.getElementById('h_ribbon').value,
              wreaths: document.getElementById('h_wreaths').value,
              garland_sections: document.getElementById('h_garland').value,
              stair_sections: document.getElementById('h_stairs').value,
              mantle: document.getElementById('h_mantle').value,
              tablescapes: document.getElementById('h_tables').value,
              storage: document.getElementById('h_storage').value,
              shopping_trips: document.getElementById('h_trips').value,
              teardown: document.getElementById('h_teardown').value
            };
            const res = (window.calcHoliday ? calcHoliday(data) : {price:0, teamHours:0, teardownHours:0, teardownPrice:0});
            const fancyHint = labelFromHours(res.teamHours, occasion);
            const lines = [
              `Install est: <strong>$${res.price}</strong>`,
              `Team time: ~${res.teamHours} hrs`,
            ];
            if (res.teardownHours){
              lines.push(`Teardown: ~${res.teardownHours} hrs ‚Ä¢ approx <strong>$${res.teardownPrice}</strong>`);
            }
            lines.push(`<span class="hint">${fancyHint}</span>`);
            out.innerHTML = lines.join('<br>');
            return;
          }

          out.textContent = 'Pick a service.';
        } catch (e){
          console.warn(e);
          out.textContent = 'Could not calculate. Check your inputs.';
        }
      });
    }

    function wireAdminHelp(){
      const launcher = document.getElementById('admin-help-launcher');
      const panel = document.getElementById('admin-help');
      const thread = document.getElementById('ah-thread');
      const input = document.getElementById('ah-input');
      const send = document.getElementById('ah-send');
      const close = document.querySelector('#admin-help .ah-close');
      const quick = document.querySelector('#admin-help .ah-quick');
      const bookUrl = "https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9";

      function addMsg(html, who="bot"){
        const b=document.createElement("div");
        b.className=`ah-bubble ${who}`; b.innerHTML=html;
        thread.appendChild(b); thread.scrollTop=thread.scrollHeight;
      }
      function greet(){
        addMsg("Hi! Admin helper here. Ask about quoting, statuses, assigning, booking links ‚Äî or type a holiday like <em>Game Day</em>, <em>Birthday</em>, or <em>Christmas</em> to see which fields to fill in.");
      }
      function detectIntent(t){
        t=(t||"").toLowerCase();
        if (/\b(game\s*day|gameday|super ?bowl|football|sports)\b/.test(t)) return "gameday";
        if (/\b(birthday|bday)\b/.test(t)) return "birthday";
        if (/\b(christmas|xmas)\b/.test(t)) return "christmas";
        if (/\b(holiday|event|which fields|holiday cheat|help.*holiday)\b/.test(t)) return "holiday";
        if (/quote|estimate|price|how do i quote/.test(t)) return "quote";
        if (/organizing|closet|pantry|garage/.test(t)) return "organizing";
        if (/assign|unassign|add.*contractor/.test(t)) return "assign";
        if (/status|submitted|approved|paid|claimed/.test(t)) return "status";
        if (/book|calendar|square/.test(t)) return "booking";
        return "fallback";
      }
      function answer(intent){
        const booking = `Send the calendar: <a href="${bookUrl}" target="_blank" rel="noopener">Open Square</a>.`;
        const estTab = `Use the <strong>Estimate</strong> tab for a fast ballpark (no saving).`;
        const GAME_DAY = [
          "<strong>Game Day (Holiday/Event):</strong>",
          "Holiday/Event = <strong>Game Day</strong>",
          "Set: <em>Tablescapes</em> (coffee table, console, food bar), <em>Garland</em> (entry/TV wall), <em>Wreaths</em> if any.",
          "<strong>No trees.</strong>"
        ].join("<br>");
        const BIRTHDAY = [
          "<strong>Birthday (Holiday/Event):</strong>",
          "Holiday/Event = <strong>Birthday</strong>",
          "Use: <em>Tablescapes</em> (cake/gift table), <em>Garland</em>, <em>Mantle</em> if used.",
          "<strong>No trees.</strong>"
        ].join("<br>");
        const CHRISTMAS = [
          "<strong>Christmas (Holiday/Event):</strong>",
          "Holiday/Event = <strong>Christmas</strong>",
          "Set: <strong># Trees + Tallest Size + Style</strong> (add <em>Ribbon</em> if used).",
          "Then add: <em>Wreaths</em> / <em>Garland</em> / <em>Stairs</em> / <em>Mantle</em> / <em>Tablescapes</em>."
        ].join("<br>");
        switch(intent){
          case "gameday":   return GAME_DAY;
          case "birthday":  return BIRTHDAY;
          case "christmas": return CHRISTMAS;
          case "holiday":
            return [
              "<strong>Holiday/Event cheat sheet</strong>",
              GAME_DAY, "", BIRTHDAY, "", CHRISTMAS,
              "<span class='small' style='opacity:.8'>Tip: Storage (Attic/Offsite) + Shopping Trips add time; optional Teardown quotes its own hours + $.</span>"
            ].join("<br>");
          case "quote":
            return [
              estTab,
              "‚Ä¢ Cleaning: size/service, beds/baths, add-ons ‚Üí time hint.",
              "‚Ä¢ Organizing: area/size + clutter/decision ‚Üí time hint.",
              "‚Ä¢ Decor/Holiday: pick elements; Christmas unlocks tree fields.",
              booking
            ].join("<br>");
          case "organizing":
            return [
              "Organizing defaults: Medium area ‚âà 3‚Äì4 hr team block.",
              "Heavier clutter / slower decisions increase hours; bins/labels add a bit.",
              estTab
            ].join("<br>");
          case "assign":
            return [
              "Open/All Jobs ‚Üí card actions:",
              "‚Ä¢ <strong>Assign me</strong> adds you.",
              "‚Ä¢ <strong>Assign by email</strong> finds user by email and adds them.",
              "‚Ä¢ <strong>Unassign</strong> removes a UID.",
              "Status flips to <em>claimed</em> when all slots are filled."
            ].join("<br>");
          case "status":
            return [
              "<code>open ‚Üí claimed ‚Üí in_progress ‚Üí submitted ‚Üí approved ‚Üí paid</code>",
              "Contractors progress jobs; you can override with the dropdown.",
              "Use <em>Private note</em> for entry codes/PII."
            ].join("<br>");
          case "booking": return booking;
          default:
            return "Try: ‚ÄúGame Day fields‚Äù, ‚ÄúBirthday fields‚Äù, ‚ÄúChristmas fields‚Äù, or ‚ÄúHoliday cheat sheet‚Äù. Also: ‚ÄúHow do I quote?‚Äù, ‚ÄúAssign a job‚Äù, ‚ÄúStatuses‚Äù, ‚ÄúBooking link‚Äù.";
        }
      }
      function sendText(txt){
        const t = (txt||"").trim(); if(!t) return;
        addMsg(t, "me");
        setTimeout(()=> addMsg(answer(detectIntent(t))), 120);
      }
      const launcher = document.getElementById("admin-help-launcher");
      const panel = document.getElementById("admin-help");
      const thread = document.getElementById("ah-thread");
      const close = document.querySelector(".ah-close");
      const input = document.getElementById("ah-input");
      const send = document.getElementById("ah-send");
      const quick = document.querySelector(".ah-quick");

      launcher.addEventListener('click', ()=>{
        panel.style.display = 'block';
        if (!thread.dataset.greeted){ greet(); thread.dataset.greeted="1"; }
        input.focus();
      });
      close.addEventListener('click', ()=> panel.style.display='none');
      send.addEventListener('click', ()=>{ sendText(input.value); input.value=""; });
      input.addEventListener('keydown', (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendText(input.value); input.value=""; }});
      quick.addEventListener('click', (e)=>{
        if (!e.target.matches('button[data-q]')) return;
        const q = e.target.getAttribute('data-q');
        addMsg(e.target.textContent, "me");
        setTimeout(()=> addMsg(answer(q)), 120);
      });
    }

    function init(){
      renderChips();

      // Open jobs
      onSnapshot(
        query(collection(db,"jobs"), where("status","==","open")),
        snap => {
          const byCreatedDesc = (a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0);
          lastOpen = snap.docs.map(d=>({id:d.id, ...d.data()})).sort(byCreatedDesc);
          drawOpen(lastOpen);
        }
      );

      // All jobs
      onSnapshot(
        query(collection(db,"jobs"), orderBy("createdAt","desc"), limit(200)),
        snap => { lastAll = snap.docs.map(d=>({id:d.id, ...d.data()})); drawAll(lastAll); }
      );

      onSnapshot(
        query(collection(db,"users"), where("role","in",["contractor","admin"])),
        snap => { drawPeople(elCons, snap.docs.map(d=>({id:d.id, ...d.data()})), "contractor"); }
      );
      onSnapshot(
        query(collection(db,"users"), where("role","==","client")),
        snap => { drawPeople(elClients, snap.docs.map(d=>({id:d.id, ...d.data()})), "client"); }
      );
      onSnapshot(
        query(collection(db,"users"), where("role","==","pending")),
        snap => { drawApps(snap.docs.map(d=>({id:d.id, ...d.data()}))); }
      );

      wireCreateForm();
      wireEstimator();
      wireAdminHelp();
    }

    let lastOpen=[], lastAll=[];
  </script>
</body>
</html>




