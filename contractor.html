<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contractor – The Finishing Touch</title>

  <!-- Fonts & Site CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body { background: var(--paper, #fbf8f4); }
    .portal { width:min(1100px, 94%); margin: 24px auto 60px; }
    .topbar {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#fff; padding:12px 16px; border-radius:14px; box-shadow:var(--shadow, 0 10px 30px rgba(0,0,0,.08));
      flex-wrap:wrap;
    }
    .brand-mini { display:flex; align-items:center; gap:.6rem; }
    .brand-mini .vase-logo { width:28px; height:36px; background:url('logo-vase.png') center / contain no-repeat; display:inline-block; }
    .rolepill { font-size:.8rem; padding:.2rem .6rem; border-radius:999px; border:1px solid #e3d9ce; background:#fffdfb; }
    .right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .small { font-size:.9rem; opacity:.85; }

    .tabs { display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .tabbtn {
      border:1.5px solid #e3d9ce; background:#fff; color:#2e2a27; border-radius:999px; padding:.5rem .85rem; font-weight:800; cursor:pointer; white-space:nowrap;
    }
    .tabbtn.active { background: var(--accent, #d2bda9); border-color: var(--accent, #d2bda9); color:#2a2624; }

    .filters { display:flex; gap:8px; flex-wrap:wrap; }
    .chip {
      border:1px solid #e3d9ce; background:#fffdfb; color:#2e2a27; border-radius:999px; padding:.35rem .7rem; cursor:pointer; font-weight:800; font-size:.9rem;
      white-space:nowrap;
    }
    .chip.active { background:#2e2a27; color:#fff; border-color:#2e2a27; }

    .main { margin-top:14px; display:grid; grid-template-columns: 1fr; gap:14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .card {
      background:#fff; border-radius:14px; box-shadow:var(--shadow, 0 10px 30px rgba(0,0,0,.08));
      padding:14px; display:flex; flex-direction:column; gap:10px;
    }
    .toprow { display:flex; justify-content:space-between; gap:8px; align-items:baseline; }
    .muted { opacity:.85; }
    .meta { display:flex; gap:10px; flex-wrap:wrap; font-size:.95rem; opacity:.95; }
    .meta span { display:inline-flex; align-items:center; gap:6px; }
    .pay { font-weight:800; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:2px; }
    .btn { display:inline-block; padding:.55rem .85rem; border-radius:999px; font-weight:800; text-decoration:none; cursor:pointer; }
    .btn-outline { border:1.5px solid #2e2a27; background:#fff; color:#2e2a27; }
    .btn-solid { background: var(--accent, #d2bda9); color:#2a2624; border:0; }
    .empty { text-align:center; padding:24px; background:#fff; border-radius:14px; border:1px dashed #e3d9ce; }

    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 16px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 10px 25px rgba(0,0,0,.25); z-index: 99999; font-weight:700; display:none;
    }
  </style>
</head>
<body>
  <div class="portal">
    <!-- Top bar -->
    <div class="topbar" role="banner">
      <div class="brand-mini">
        <span class="vase-logo" aria-hidden="true"></span>
        <div>
          <div style="font-family:'Playfair Display',serif; line-height:1; color:#2e2a27;">The Finishing Touch</div>
          <div id="rolePill" class="rolepill">Checking role…</div>
        </div>
      </div>
      <div class="right">
        <span id="whoami" class="small"></span>
        <a class="btn btn-outline" href="index.html">Home</a>
        <a id="adminIntakeBtn" class="btn btn-solid" href="admin.html" hidden>Manual Intake</a>
        <a id="signOutBtn" class="btn btn-outline" href="#" aria-label="Sign out">Sign out</a>
      </div>
    </div>

    <!-- Tabs + filters -->
    <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div class="tabs" role="tablist" aria-label="Job views">
        <button id="tabOpen" class="tabbtn active" type="button" role="tab" aria-selected="true" aria-controls="panelOpen">Open Jobs</button>
        <button id="tabMine" class="tabbtn" type="button" role="tab" aria-selected="false" aria-controls="panelMine">My Jobs</button>
      </div>
      <div class="filters" id="filterChips" aria-label="Filters"></div>
    </div>

    <!-- Panels -->
    <section id="panelOpen" class="main" role="tabpanel" aria-labelledby="tabOpen">
      <div id="openJobs" class="grid" aria-live="polite"></div>
    </section>

    <section id="panelMine" class="main" role="tabpanel" aria-labelledby="tabMine" hidden>
      <div id="myJobs" class="grid" aria-live="polite"></div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase / Firestore logic -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      collection, query, where, onSnapshot,
      doc, getDoc, updateDoc, serverTimestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const rolePill   = document.getElementById('rolePill');
    const whoami     = document.getElementById('whoami');
    const btnSignOut = document.getElementById('signOutBtn');
    const chipsWrap  = document.getElementById('filterChips');
    const adminBtn   = document.getElementById('adminIntakeBtn');

    const tabOpen    = document.getElementById('tabOpen');
    const tabMine    = document.getElementById('tabMine');
    const panelOpen  = document.getElementById('panelOpen');
    const panelMine  = document.getElementById('panelMine');

    const openJobsEl = document.getElementById('openJobs');
    const myJobsEl   = document.getElementById('myJobs');
    const toastEl    = document.getElementById('toast');

    let me = null;
    let meRole = 'contractor';
    let meServices = [];
    let activeFilter = 'all';
    let lastOpenJobs = [], lastMyJobs = [];

    const ALL_TYPES = ['cleaning','organizing','decor','holiday'];

    function showToast(msg, ms=1900){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=> toastEl.style.display = 'none', ms);
    }
    function cap(s){ return s ? (s[0].toUpperCase() + s.slice(1)) : ''; }
    function fmtPay(n){
      if (typeof n === 'number' && !isNaN(n)) return `$${Math.round(n)}`;
      const x = Number(n); return isFinite(x) ? `$${Math.round(x)}` : '';
    }
    function fmtDate(d){
      try { return new Date(d).toLocaleDateString([], { month:'short', day:'numeric' }); } catch { return d || ''; }
    }
    function payForContractor(j){
      const p = j.payEach ?? j.contractorPayEach ?? j.payPerContractor ?? j.contractorPay ?? null;
      return p != null ? `Your pay est: <span class="pay">${fmtPay(p)}</span>` : '';
    }
    function slotsLeft(j){
      const need = Number(j.contractorsNeeded || 1);
      const have = Array.isArray(j.contractorIds) ? j.contractorIds.length : (j.contractorId ? 1 : 0);
      const left = Math.max(0, need - have);
      return { need, have, left };
    }
    function canClaimRole(){ return meRole === 'contractor' || meRole === 'admin'; }

    function setTab(which){
      const open = which === 'open';
      tabOpen.classList.toggle('active', open);
      tabMine.classList.toggle('active', !open);
      tabOpen.setAttribute('aria-selected', String(open));
      tabMine.setAttribute('aria-selected', String(!open));
      panelOpen.hidden = !open;
      panelMine.hidden = open;
    }
    tabOpen.addEventListener('click', () => setTab('open'));
    tabMine.addEventListener('click', () => setTab('mine'));

    function renderChips(){
      const allowed = (meServices && meServices.length)
        ? meServices.map(s => String(s).toLowerCase())
        : ALL_TYPES;
      const types = ['all', ...allowed];
      chipsWrap.innerHTML = '';
      types.forEach(t => {
        const b = document.createElement('button');
        b.className = 'chip' + (t === activeFilter ? ' active' : '');
        b.type = 'button';
        b.textContent = t === 'all' ? 'All' : (t[0].toUpperCase() + t.slice(1));
        b.addEventListener('click', () => {
          activeFilter = t;
          renderChips();
          drawOpenJobs(lastOpenJobs);
          drawMyJobs(lastMyJobs);
        });
        chipsWrap.appendChild(b);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        const next = encodeURIComponent('contractor.html');
        location.href = `login.html?next=${next}`;
        return;
      }
      me = user;
      whoami.textContent = user.email || user.uid;

      try {
        const snap = await getDoc(doc(db, 'users', user.uid));
        const data = snap.exists() ? snap.data() : {};
        meRole = (data.role || 'contractor').toLowerCase();
        // *** normalize to lowercase so filters match ***
        meServices = Array.isArray(data.serviceTypes) ? data.serviceTypes.map(s=>String(s).toLowerCase()) : [];
        rolePill.textContent = (meRole === 'admin') ? 'Admin + Contractor' : 'Contractor';
        if (adminBtn) adminBtn.hidden = (meRole !== 'admin');
      } catch (e) {
        console.warn(e);
        rolePill.textContent = 'Contractor';
        if (adminBtn) adminBtn.hidden = true;
      }

      renderChips();
      startListeners();
    });

    btnSignOut.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await signOut(auth); } finally { location.href = 'index.html'; }
    });

    let unsubOpen = null, unsubMineA = null, unsubMineB = null;

    function startListeners(){
      // Open jobs (NO orderBy; sort in JS to avoid index requirement)
      unsubOpen = onSnapshot(
        query(collection(db, 'jobs'), where('status', '==', 'open')),
        (snap) => {
          const byCreatedDesc = (a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0);
          lastOpenJobs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort(byCreatedDesc);
          drawOpenJobs(lastOpenJobs);
        },
        (err) => console.warn('open jobs listener error:', err)
      );

      // My jobs — legacy single-assignee
      unsubMineA = onSnapshot(
        query(collection(db, 'jobs'), where('contractorId', '==', (me?.uid || ''))),
        (snap) => mergeMine(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
        (err) => console.warn('my jobs (A) listener error:', err)
      );

      // My jobs — new multi-assignee
      unsubMineB = onSnapshot(
        query(collection(db, 'jobs'), where('contractorIds', 'array-contains', (me?.uid || ''))),
        (snap) => mergeMine(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
        (err) => console.warn('my jobs (B) listener error:', err)
      );
    }

    function mergeMine(list){
      const map = new Map(lastMyJobs.map(j => [j.id, j]));
      list.forEach(j => map.set(j.id, j));
      lastMyJobs = Array.from(map.values());
      drawMyJobs(lastMyJobs);
    }

    function jobCardHTML(j, inMine=false){
      const type  = (j.serviceType || '').toLowerCase();
      const title = type ? cap(type) : 'Job';
      const zip   = j.zip || j.postal || j.postcode || j.area || j.city || '';
      const when  = j.date ? fmtDate(j.date) + (j.timeWindow ? ` • ${j.timeWindow}` : '') : (j.window || '');
      const bb    = (j.beds || j.baths) ? `${j.beds||0} bd / ${j.baths||0} ba` : '';
      const hours = j.estimatedTeamHours || j.teamHours || j.eta || '';
      const { need, left } = slotsLeft(j);
      const leftTxt = need > 1 ? `${left} of ${need} slots left` : '';
      const payLine = payForContractor(j);
      const statusChip = j.status ? `<span>• ${j.status}</span>` : '';

      return `
        <div class="card" data-jobid="${j.id}">
          <div class="toprow">
            <strong>${title}</strong>
            ${payLine ? `<div class="muted">${payLine}</div>` : ''}
          </div>
          <div class="meta">
            ${zip   ? `<span>📍 <span>${zip}</span></span>` : ''}
            ${when  ? `<span>🗓️ <span>${when}</span></span>` : ''}
            ${bb    ? `<span>🛏️ <span>${bb}</span></span>` : ''}
            ${hours ? `<span>⏱️ <span>${hours}</span></span>` : ''}
            ${leftTxt ? `<span>👥 <span>${leftTxt}</span></span>` : ''}
            ${statusChip}
          </div>
          ${j.summary ? `<div style="font-size:.98rem;">${j.summary}</div>` : (j.notes ? `<div style="font-size:.98rem;">${j.notes}</div>` : '')}
          <div class="actions"></div>
        </div>
      `;
    }

    function drawOpenJobs(list){
      const allowed = (meServices && meServices.length) ? meServices : ALL_TYPES;
      const filtered = list.filter(j => {
        const type = (j.serviceType || '').toLowerCase();
        const okType = allowed.includes(type);
        const chipOk = (activeFilter === 'all') ? true : (type === activeFilter);
        return okType && chipOk;
      });

      if (!filtered.length){
        openJobsEl.innerHTML = `<div class="empty">No open jobs right now.</div>`;
        return;
      }
      openJobsEl.innerHTML = filtered.map(j => jobCardHTML(j, false)).join('');
      filtered.forEach(j => injectOpenActions(j));
    }

    function drawMyJobs(list){
      if (!list.length){
        myJobsEl.innerHTML = `<div class="empty">You haven’t claimed any jobs yet.</div>`;
        return;
      }
      myJobsEl.innerHTML = list.map(j => jobCardHTML(j, true)).join('');
      list.forEach(j => injectMineActions(j));
    }

    function injectOpenActions(j){
      const card = openJobsEl.querySelector(`[data-jobid="${j.id}"]`);
      if (!card) return;
      const actions = card.querySelector('.actions');

      if (canClaimRole()){
        const { left } = slotsLeft(j);
        const claim = document.createElement('button');
        claim.className = 'btn btn-solid';
        claim.textContent = left > 1 ? 'Claim a slot' : 'Claim this job';
        claim.addEventListener('click', () => claimJob(j.id, claim));
        actions.appendChild(claim);
      }

      const msg = document.createElement('a');
      msg.className = 'btn btn-outline';
      msg.textContent = 'Message Admin';
      msg.href = '#';
      msg.addEventListener('click', (e)=>{ e.preventDefault(); alert('Messaging coming soon.'); });
      actions.appendChild(msg);
    }

    function injectMineActions(j){
      const card = myJobsEl.querySelector(`[data-jobid="${j.id}"]`);
      if (!card) return;
      const actions = card.querySelector('.actions');

      const msg = document.createElement('a');
      msg.className = 'btn btn-outline';
      msg.textContent = 'Message Admin';
      msg.href = '#';
      msg.addEventListener('click', (e)=>{ e.preventDefault(); alert('Messaging coming soon.'); });
      actions.appendChild(msg);

      const mark = document.createElement('button');
      mark.className = 'btn btn-solid';
      mark.textContent = j.status === 'in_progress' ? 'Mark Submitted'
                      : (j.status === 'claimed' ? 'Start Work'
                      : (j.status === 'submitted' ? 'Submitted' : 'Update Status'));
      mark.disabled = (j.status === 'submitted' || j.status === 'approved' || j.status === 'paid');
      mark.addEventListener('click', async () => {
        try {
          const newStatus = j.status === 'claimed' ? 'in_progress' : 'submitted';
          await updateDoc(doc(db, 'jobs', j.id), { status: newStatus, updatedAt: serverTimestamp() });
          showToast(newStatus === 'in_progress' ? 'Marked in progress' : 'Marked submitted');
        } catch (e) {
          console.warn(e);
          alert('Could not update status.');
        }
      });
      actions.appendChild(mark);
    }

    async function claimJob(jobId, buttonEl){
      if (!me) return;
      if (buttonEl) { buttonEl.disabled = true; buttonEl.textContent = 'Claiming…'; }

      try {
        await runTransaction(db, async (tx) => {
          const ref = doc(db, 'jobs', jobId);
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error('Job not found.');
          const j = snap.data();

          if ((j.status || 'open') !== 'open') throw new Error('Already claimed.');

          const need = Number(j.contractorsNeeded || 1);
          const ids = Array.isArray(j.contractorIds) ? [...j.contractorIds]
                    : (j.contractorId ? [j.contractorId] : []);
          if (ids.includes(me.uid)) return;
          if (ids.length >= need) throw new Error('No slots left.');

          ids.push(me.uid);
          const emails = Array.isArray(j.contractorEmails) ? [...j.contractorEmails] : [];
          const myEmail = me.email || '';
          if (myEmail && !emails.includes(myEmail)) emails.push(myEmail);

          const update = {
            contractorIds: ids,
            contractorEmails: emails,
            updatedAt: serverTimestamp()
          };
          if (ids.length >= need) {
            update.status = 'claimed';
            update.claimedAt = serverTimestamp();
          } else {
            update.status = 'open';
          }
          tx.update(ref, update);
        });

        showToast('Job claimed');
        setTab('mine');
      } catch (e) {
        console.warn(e);
        const msg = (e && e.code === 'permission-denied')
          ? 'Permission denied claiming. Check Firestore rules for the contractor-claim update.'
          : (e.message || 'Could not claim. It may have just been taken.');
        alert(msg);
      } finally {
        if (buttonEl) { buttonEl.disabled = false; buttonEl.textContent = 'Claim this job'; }
      }
    }
  </script>
</body>
</html>




