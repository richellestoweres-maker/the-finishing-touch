<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contractor ‚Äì The Finishing Touch</title>

  <!-- Fonts & Site CSS (reuses your brand styles) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body { background: var(--paper, #fbf8f4); }
    .portal { width:min(1100px, 94%); margin: 24px auto 60px; }
    .topbar {
      display:flex; align-items:center; justify-content:space-between;
      background:#fff; padding:12px 16px; border-radius:14px; box-shadow:var(--shadow, 0 10px 30px rgba(0,0,0,.08));
    }
    .brand-mini { display:flex; align-items:center; gap:.6rem; }
    .brand-mini .vase-logo { width:28px; height:36px; background:url('logo-vase.png') center / contain no-repeat; display:inline-block; }
    .tabs { display:flex; gap:10px; }
    .tabbtn {
      border:1px solid #e3d9ce; background:#fff; color:#2e2a27; border-radius:999px; padding:.5rem .85rem; font-weight:700; cursor:pointer;
    }
    .tabbtn.active { background: var(--accent, #d2bda9); border-color: var(--accent, #d2bda9); color:#2a2624; }
    .main {
      margin-top:14px; display:grid; grid-template-columns: 1fr; gap:14px;
    }
    .filters { display:flex; gap:8px; flex-wrap:wrap; }
    .chip {
      border:1px solid #e3d9ce; background:#fffdfb; color:#2e2a27; border-radius:999px; padding:.35rem .7rem; cursor:pointer; font-weight:700; font-size:.9rem;
    }
    .chip.active { background:#2e2a27; color:#fff; border-color:#2e2a27; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .card {
      background:#fff; border-radius:14px; box-shadow:var(--shadow, 0 10px 30px rgba(0,0,0,.08));
      padding:14px; display:flex; flex-direction:column; gap:8px;
    }
    .meta { display:flex; gap:8px; flex-wrap:wrap; font-size:.92rem; opacity:.9; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
    .btn { display:inline-block; padding:.55rem .85rem; border-radius:999px; font-weight:800; text-decoration:none; cursor:pointer; }
    .btn-outline { border:1.5px solid #2e2a27; background:#fff; color:#2e2a27; }
    .btn-solid { background: var(--accent, #d2bda9); color:#2a2624; border:0; }
    .empty { text-align:center; padding:24px; background:#fff; border-radius:14px; border:1px dashed #e3d9ce; }
    .rolepill { font-size:.8rem; padding:.2rem .5rem; border-radius:999px; border:1px solid #e3d9ce; background:#fffdfb; }
    .right { display:flex; align-items:center; gap:10px; }
    .small { font-size:.9rem; opacity:.85; }
    .danger { color:#b00020; font-weight:700; }
  </style>
</head>
<body>
  <div class="portal">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand-mini">
        <span class="vase-logo" aria-hidden="true"></span>
        <div>
          <div style="font-family:'Playfair Display',serif; line-height:1; color:#2e2a27;">The Finishing Touch</div>
          <div id="rolePill" class="rolepill">Checking role‚Ä¶</div>
        </div>
      </div>
      <div class="right">
        <span id="whoami" class="small"></span>
        <a id="homeLink" class="btn btn-outline" href="index.html">Home</a>
        <a id="signOutBtn" class="btn btn-outline" href="#">Sign out</a>
      </div>
    </div>

    <!-- Tabs -->
    <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div class="tabs">
        <button id="tabOpen" class="tabbtn active" type="button">Open Jobs</button>
        <button id="tabMine" class="tabbtn" type="button">My Jobs</button>
      </div>
      <div class="filters" id="filterChips" aria-label="Filters"></div>
    </div>

    <!-- Panels -->
    <section id="panelOpen" class="main">
      <div id="openJobs" class="grid" aria-live="polite"></div>
    </section>

    <section id="panelMine" class="main" hidden>
      <div id="myJobs" class="grid" aria-live="polite"></div>
    </section>
  </div>

  <!-- Firebase / Firestore logic -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import {
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      collection, query, where, orderBy, onSnapshot,
      doc, getDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // ---- DOM refs
    const rolePill = document.getElementById('rolePill');
    const whoami   = document.getElementById('whoami');
    const btnSignOut = document.getElementById('signOutBtn');
    const chipsWrap  = document.getElementById('filterChips');

    const tabOpen = document.getElementById('tabOpen');
    const tabMine = document.getElementById('tabMine');
    const panelOpen = document.getElementById('panelOpen');
    const panelMine = document.getElementById('panelMine');

    const openJobsEl = document.getElementById('openJobs');
    const myJobsEl   = document.getElementById('myJobs');

    // ---- State
    let me = null;                // auth user
    let meRole = 'contractor';    // default
    let meServices = [];          // allowed service types
    let activeFilter = 'all';     // chip filter

    // ---- Tabs
    function setTab(which){
      const open = which === 'open';
      tabOpen.classList.toggle('active', open);
      tabMine.classList.toggle('active', !open);
      panelOpen.hidden = !open;
      panelMine.hidden = open;
    }
    tabOpen.addEventListener('click', () => setTab('open'));
    tabMine.addEventListener('click', () => setTab('mine'));

    // ---- Chips
    const ALL_TYPES = ['cleaning','organizing','decor','holiday'];
    function renderChips(){
      const allowed = meRole === 'admin' ? ALL_TYPES : (meServices.length ? meServices : ALL_TYPES);
      const types = ['all', ...allowed];
      chipsWrap.innerHTML = '';
      types.forEach(t => {
        const b = document.createElement('button');
        b.className = 'chip' + (t === activeFilter ? ' active' : '');
        b.type = 'button';
        b.textContent = t === 'all' ? 'All' : (t[0].toUpperCase() + t.slice(1));
        b.addEventListener('click', () => {
          activeFilter = t;
          renderChips();
          // Re-render lists with current filter
          drawOpenJobs(lastOpenJobs);
          drawMyJobs(lastMyJobs);
        });
        chipsWrap.appendChild(b);
      });
    }

    // ---- Auth gate
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // send to login, return here after
        const next = encodeURIComponent('contractor.html');
        location.href = `login.html?next=${next}`;
        return;
      }
      me = user;
      whoami.textContent = user.email || user.uid;

      // Load role doc
      try {
        const userRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userRef);
        const data = snap.exists() ? snap.data() : {};
        meRole = (data.role || 'contractor').toLowerCase();
        meServices = Array.isArray(data.serviceTypes) ? data.serviceTypes : [];
        rolePill.textContent = meRole === 'admin' ? 'Admin + Contractor' : 'Contractor';
      } catch (e) {
        console.warn(e);
        rolePill.textContent = 'Contractor';
      }
      renderChips();
      startListeners();
    });

    // ---- Sign out
    btnSignOut.addEventListener('click', async (e) => {
      e.preventDefault();
      await signOut(auth);
      location.href = 'index.html';
    });

    // ---- Firestore listeners
    let unsubOpen = null, unsubMine = null;
    let lastOpenJobs = [], lastMyJobs = [];

    function startListeners(){
      // Open jobs
      const qOpen = query(
        collection(db, 'jobs'),
        where('status', '==', 'open'),
        orderBy('createdAt', 'desc')
      );
      unsubOpen = onSnapshot(qOpen, (snap) => {
        lastOpenJobs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        drawOpenJobs(lastOpenJobs);
      });

      // My jobs
      unsubMine = onSnapshot(
        query(collection(db, 'jobs'), where('contractorId', '==', me.uid)),
        (snap) => {
          lastMyJobs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          drawMyJobs(lastMyJobs);
        }
      );
    }

    // ---- Renderers
    function jobCardHTML(j){
      const rate = (typeof j.flatRate === 'number') ? `$${j.flatRate}` : (j.rate || '');
      const type = (j.serviceType || '').toLowerCase();
      const capType = type ? (type[0].toUpperCase()+type.slice(1)) : 'Job';
      const area = j.area || j.city || '';
      const windowTxt = j.window || '';
      const summary = j.summary || j.notes || '';

      return `
        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:8px;">
            <strong>${capType}</strong>
            <strong>${rate}</strong>
          </div>
          <div class="meta">
            ${area ? `<span>üìç ${area}</span>` : ''}
            ${windowTxt ? `<span>üïí ${windowTxt}</span>` : ''}
            ${j.status ? `<span>‚Ä¢ ${j.status}</span>` : ''}
          </div>
          ${summary ? `<div style="font-size:.98rem;">${summary}</div>` : ''}
          <div class="actions" data-jobid="${j.id}">
            <!-- buttons injected per list -->
          </div>
        </div>
      `;
    }

    function drawOpenJobs(list){
      // filter by allowed type
      const allowed = meRole === 'admin' ? ALL_TYPES : (meServices.length ? meServices : ALL_TYPES);
      const filtered = list.filter(j => {
        const type = (j.serviceType || '').toLowerCase();
        const okType = allowed.includes(type);
        const chipOk = (activeFilter === 'all') ? true : (type === activeFilter);
        return okType && chipOk;
      });

      if (!filtered.length){
        openJobsEl.innerHTML = `<div class="empty">No open jobs right now.</div>`;
        return;
      }
      openJobsEl.innerHTML = filtered.map(jobCardHTML).join('');

      // attach Claim buttons
      filtered.forEach(j => {
        const wrap = openJobsEl.querySelector(`[data-jobid="${j.id}"]`);
        if (!wrap) return;
        const claim = document.createElement('button');
        claim.className = 'btn btn-solid';
        claim.textContent = 'Claim this job';
        claim.addEventListener('click', () => claimJob(j.id));
        wrap.appendChild(claim);

        const msg = document.createElement('a');
        msg.className = 'btn btn-outline';
        msg.textContent = 'Message Admin';
        msg.href = '#'; // chat soon
        msg.addEventListener('click', (e)=>{ e.preventDefault(); alert('Chat coming next!'); });
        wrap.appendChild(msg);
      });
    }

    function drawMyJobs(list){
      if (!list.length){
        myJobsEl.innerHTML = `<div class="empty">You haven‚Äôt claimed any jobs yet.</div>`;
        return;
      }
      // optional filter by chip here (rarely needed)
      myJobsEl.innerHTML = list.map(jobCardHTML).join('');

      list.forEach(j => {
        const wrap = myJobsEl.querySelector(`[data-jobid="${j.id}"]`);
        if (!wrap) return;

        // In-progress actions
        const msg = document.createElement('a');
        msg.className = 'btn btn-outline';
        msg.textContent = 'Message Admin';
        msg.href = '#';
        msg.addEventListener('click', (e)=>{ e.preventDefault(); alert('Chat coming next!'); });
        wrap.appendChild(msg);

        const mark = document.createElement('button');
        mark.className = 'btn btn-solid';
        mark.textContent = j.status === 'in_progress' ? 'Mark Submitted' : (j.status === 'claimed' ? 'Start Work' : 'Submitted');
        mark.disabled = (j.status === 'submitted' || j.status === 'approved' || j.status === 'paid');
        mark.addEventListener('click', async () => {
          try {
            const newStatus = j.status === 'claimed' ? 'in_progress' : 'submitted';
            await updateDoc(doc(db, 'jobs', j.id), {
              status: newStatus,
              updatedAt: serverTimestamp()
            });
          } catch (e) {
            alert('Could not update status.');
            console.warn(e);
          }
        });
        wrap.appendChild(mark);
      });
    }

    // ---- Claim flow (simple, race-safe enough for MVP)
    async function claimJob(jobId){
      if (!me) return;
      try {
        // quick check: don‚Äôt claim if already claimed in current view
        const card = document.querySelector(`[data-jobid="${jobId}"]`);
        if (card) {
          const b = card.querySelector('.btn.btn-solid');
          if (b) { b.disabled = true; b.textContent = 'Claiming‚Ä¶'; }
        }
        await updateDoc(doc(db, 'jobs', jobId), {
          status: 'claimed',
          contractorId: me.uid,
          contractorEmail: me.email || '',
          claimedAt: serverTimestamp()
        });
        setTab('mine'); // jump to My Jobs
      } catch (e) {
        alert('Could not claim. It may have just been taken.');
        console.warn(e);
      }
    }
  </script>
</body>
</html>

