<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Manual Intake (Create Job)</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    body{background:#fbf8f4}
    .wrap{width:min(960px,92%);margin:28px auto 60px;background:#fff;padding:24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    h1{font-family:"Playfair Display",serif;margin:0 0 .75rem;color:#2e2a27}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .grid-1{display:grid;gap:14px}
    label{display:grid;gap:6px;font-weight:700;color:#2e2a27}
    input,select,textarea{border:1px solid #e3d9ce;border-radius:12px;padding:.75rem;background:#fffdfb;color:#2e2a27}
    .row{margin:14px 0;border-top:1px solid #e8ddd1;padding-top:14px}
    .muted{opacity:.85}
    .btn{display:inline-block;padding:.65rem 1rem;border-radius:999px;font-weight:800;cursor:pointer;text-decoration:none}
    .btn-solid{background:#d2bda9;color:#2a2624;border:0}
    .btn-outline{border:1.5px solid #2a2624;color:#2a2624;background:#fff}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .card{border:1px solid #e8ddd1;border-radius:12px;padding:12px;background:#fffdfb}
    .ok{color:#0a7d33;font-weight:800}
    .err{color:#b00020;font-weight:800}
    .right{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a href="index.html" class="brand-link" style="display:flex;align-items:center;gap:.6rem;text-decoration:none;color:inherit">
          <span class="vase-logo" aria-hidden="true"></span>
          <span class="brand-name">The Finishing Touch</span>
        </a>
      </div>
      <nav class="main-nav">
        <a href="admin.html">Admin</a>
        <a class="active" href="admin-manual.html">Manual Intake</a>
        <a href="contractor.html">Contractor</a>
        <a class="btn btn-outline" id="authBtn" href="login.html">Sign in</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1>Manual Intake – Create Job</h1>
    <p class="muted">Fill this when a client calls/texts. We’ll calculate the quote, split contractor pay, email Formspree, and post the job for contractors.</p>

    <form id="manualForm" class="grid-1">
      <!-- Client PII (kept out of job doc) -->
      <div class="row grid-2">
        <label>Client Name<input name="name" required></label>
        <label>Email<input name="email" type="email" required></label>
        <label>Phone<input name="phone" required></label>
        <label>Street Address<input name="street" required placeholder="123 Bay St"></label>
        <label>City<input name="city" required placeholder="League City"></label>
        <div class="grid-3">
          <label>State<input name="state" required value="TX"></label>
          <label>ZIP<input name="zip" required></label>
          <label>Area (display label)<input name="area" placeholder="League City"></label>
        </div>
      </div>

      <!-- Scheduling (shown to contractors) -->
      <div class="row grid-3">
        <label>Date<input name="date" type="date" required></label>
        <label>Start Time<input name="start" type="time" required></label>
        <label>End Time<input name="end" type="time" required></label>
      </div>

      <!-- Service Category -->
      <div class="row grid-3">
        <label>Service Category
          <select id="svcCategory" name="svcCategory">
            <option value="cleaning" selected>Cleaning</option>
            <option value="holiday">Holiday (Indoor)</option>
          </select>
        </label>
        <label>Contractors Needed
          <select name="contractorsNeeded">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </label>
        <label>Your Cut (%)<input name="companyCut" type="number" min="0" max="50" value="30" required></label>
      </div>

      <!-- Cleaning block (default visible) -->
      <div id="cleaningBlock" class="row grid-2">
        <label>Service
          <select name="service">
            <option>Initial Clean</option>
            <option>Standard Clean</option>
            <option>Deep Clean</option>
            <option>Move-In / Move-Out Clean</option>
            <option>Airbnb Turnover</option>
          </select>
        </label>
        <label>Frequency
          <select name="frequency">
            <option>one-time</option><option>weekly</option>
            <option>biweekly</option><option>monthly</option>
          </select>
        </label>
        <label>Bedrooms<input name="beds" type="number" min="0" value="3" required></label>
        <label>Bathrooms<input name="baths" type="number" min="0" value="2" required></label>
        <label>Other Rooms<input name="other_rooms" type="number" min="0" value="0"></label>
        <label>Square Footage
          <select name="sqft">
            <option>&lt;1000</option><option>1000–2000</option>
            <option>2000–3000</option><option>3000–4000</option><option>4000+</option>
          </select>
        </label>
        <label>Stories
          <select name="stories"><option>1</option><option>2</option></select>
        </label>
        <label>Pets (type & number)<input name="pets" /></label>
        <label>Add-ons (comma list)<input name="addons" placeholder="oven, fridge, windows, baseboards, laundry"></label>
        <label>Notes for summary<input name="notes" placeholder="e.g., initial deep clean"></label>
      </div>

      <!-- Holiday block (hidden until selected) -->
      <div id="holidayBlock" class="row grid-3" style="display:none">
        <label># Trees <input name="h_trees" type="number" min="0" value="1"></label>
        <label>Tallest Tree
          <select name="h_tallest"><option>≤6 ft</option><option selected>7–8 ft</option><option>9–10 ft</option><option>11–12+ ft</option></select>
        </label>
        <label>Tree Style
          <select name="h_style"><option>Ready: ornaments & lights on hand</option><option>Needs ribbon/theme refresh</option><option>Full design + sourcing</option></select>
        </label>
        <label>Ribbon? <select name="h_ribbon"><option>No</option><option>Yes</option></select></label>
        <label>Wreaths <input name="h_wreaths" type="number" min="0" value="0"></label>
        <label>Garland Sections <input name="h_garland" type="number" min="0" value="0"></label>
        <label>Stair Sections <input name="h_stairs" type="number" min="0" value="0"></label>
        <label>Mantle? <select name="h_mantle"><option>No</option><option>Yes</option></select></label>
        <label>Tablescapes <input name="h_tables" type="number" min="0" value="0"></label>
        <label>Storage
          <select name="h_storage"><option>Garage/closet (easy)</option><option>Attic (ladder)</option><option>Offsite pickup</option></select>
        </label>
        <label>Shopping Trips
          <select name="h_trips"><option>0</option><option>1</option><option>2</option><option>3+</option></select>
        </label>
        <label>Include Teardown? <select name="h_teardown"><option>Yes</option><option>No</option></select></label>
      </div>

      <!-- Preview + actions -->
      <div class="row">
        <div class="actions">
          <button type="button" id="btnPreview" class="btn btn-outline">Preview calculation</button>
          <button type="submit" id="btnCreate" class="btn btn-solid" disabled>Create Open Job</button>
        </div>
        <div id="calcCard" class="card" style="margin-top:10px;display:none"></div>
        <div id="status" style="margin-top:8px"></div>
      </div>
    </form>
  </main>

  <!-- Calculators: uses your public pricing logic -->
  <script src="script.js" defer></script>

  <!-- Firebase + logic -->
  <script type="module">
    import { auth, db } from "./ft-firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      collection, addDoc, serverTimestamp, setDoc, doc, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Top-right smart auth button
    const authBtn = document.getElementById('authBtn');
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authBtn.textContent = 'Sign out';
        authBtn.href = '#';
        authBtn.onclick = async (e) => { e.preventDefault(); await signOut(auth); location.reload(); };
      } else {
        authBtn.textContent = 'Sign in';
        authBtn.href = 'login.html?next=admin-manual.html';
      }
    });

    // --- UI refs
    const form = document.getElementById('manualForm');
    const btnPreview = document.getElementById('btnPreview');
    const btnCreate  = document.getElementById('btnCreate');
    const calcCard   = document.getElementById('calcCard');
    const statusEl   = document.getElementById('status');

    const svcCategory = document.getElementById('svcCategory');
    const cleaningBlock = document.getElementById('cleaningBlock');
    const holidayBlock  = document.getElementById('holidayBlock');

    // Toggle service blocks
    svcCategory.addEventListener('change', () => {
      const isHoliday = svcCategory.value === 'holiday';
      cleaningBlock.style.display = isHoliday ? 'none' : '';
      holidayBlock.style.display  = isHoliday ? '' : 'none';
      calcCard.style.display = 'none';
      statusEl.textContent = '';
      btnCreate.disabled = true;
    });

    // Helpers
    const USD = (n) => `$${Math.round(Number(n||0))}`;
    function prettyTime(hhmm){
      if(!hhmm) return '';
      let [h,m]=hhmm.split(':').map(Number);
      const ampm = h>=12?'PM':'AM'; h = (h%12)||12;
      return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
    }

    let lastPreview = null;

    // PREVIEW
    btnPreview.addEventListener('click', () => {
      statusEl.textContent = '';
      const d = Object.fromEntries(new FormData(form).entries());
      const isHoliday = (svcCategory.value === 'holiday');

      if (isHoliday) {
        // Holiday calculation via script.js
        const data = {
          trees: d.h_trees, tallest: d.h_tallest, tree_style: d.h_style, tree_ribbon: d.h_ribbon,
          wreaths: d.h_wreaths, garland_sections: d.h_garland, stair_sections: d.h_stairs,
          mantle: d.h_mantle, tablescapes: d.h_tables, storage: d.h_storage,
          shopping_trips: d.h_trips, teardown: d.h_teardown
        };
        const res = (window.calcHoliday ? window.calcHoliday(data) : {price:0, teamHours:0, teardownHours:0, teardownPrice:0});
        const hint = (window.holidayHint ? window.holidayHint(data, res.teamHours) : '');

        const cutPct = Math.min(50, Math.max(0, Number(d.companyCut||30)));
        const keep = Math.round(res.price * (cutPct/100));
        const toContractors = res.price - keep;
        const n = Math.max(1, Math.min(3, Number(d.contractorsNeeded||1)));
        const base = Math.floor(toContractors / n);
        const remainder = toContractors % n;
        const per = Array.from({length:n}, (_,i)=> base + (i<remainder?1:0));

        const windowLbl = `${prettyTime(d.start)}–${prettyTime(d.end)}`;

        calcCard.style.display = 'block';
        calcCard.innerHTML = `
          <div><strong>Client price (install):</strong> ${USD(res.price)}</div>
          ${res.teardownPrice ? `<div><strong>Teardown (optional):</strong> ${USD(res.teardownPrice)}</div>` : ``}
          <div><strong>Your cut (${cutPct}%):</strong> ${USD(keep)}</div>
          <div><strong>To contractors (total):</strong> ${USD(toContractors)} (${n} needed)</div>
          <div><strong>Per contractor:</strong> ${per.map(p=>USD(p)).join(' · ')}</div>
          <div class="muted" style="margin-top:6px">
            ${d.city || d.area || ''} · ${d.zip || ''} · ${new Date(d.date).toLocaleDateString()} ${windowLbl}<br>
            Est team time ≈ <strong>${res.teamHours}</strong> hr · ${hint}
          </div>
        `;
        btnCreate.disabled = false;

        lastPreview = {
          holiday:true,
          price: res.price,
          teamHours: res.teamHours,
          teardownHours: res.teardownHours,
          teardownPrice: res.teardownPrice,
          cutPct, toContractors, n, per,
          windowLbl
        };
        return;
      }

      // Cleaning preview (uses script.js)
      const price = (window.calcCleaning ? calcCleaning(d) : 0);
      const hours = (window.estimateHoursCleaning ? estimateHoursCleaning(d) : {teamHours:0});
      const cutPct = Math.min(50, Math.max(0, Number(d.companyCut||30)));
      const keep = Math.round(price * (cutPct/100));
      const toContractors = price - keep;
      const n = Math.max(1, Math.min(3, Number(d.contractorsNeeded||1)));
      const base = Math.floor(toContractors / n);
      const remainder = toContractors % n;
      const per = Array.from({length:n}, (_,i)=> base + (i<remainder?1:0));

      const summary = `${Number(d.beds||0)} bed / ${Number(d.baths||0)} bath — ${(d.notes||d.service||'cleaning')}.`;
      const windowLbl = `${prettyTime(d.start)}–${prettyTime(d.end)}`;

      calcCard.style.display = 'block';
      calcCard.innerHTML = `
        <div><strong>Client price:</strong> ${USD(price)}</div>
        <div><strong>Your cut (${cutPct}%):</strong> ${USD(keep)}</div>
        <div><strong>To contractors (total):</strong> ${USD(toContractors)} (${n} needed)</div>
        <div><strong>Per contractor:</strong> ${per.map(p=>USD(p)).join(' · ')}</div>
        <div class="muted" style="margin-top:6px">
          ${d.city || d.area || ''} · ${d.zip || ''} · ${new Date(d.date).toLocaleDateString()} ${windowLbl}<br>
          ${summary} · Est team time ≈ <strong>${hours.teamHours}</strong> hr
        </div>
      `;
      btnCreate.disabled = false;

      lastPreview = {
        holiday:false,
        price,
        teamHours: hours.teamHours || 0,
        cutPct, toContractors, n, per,
        summary, windowLbl
      };
    });

    // SUBMIT (Create Job)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';
      if (!lastPreview) { statusEl.innerHTML = '<span class="err">Click “Preview calculation” first.</span>'; return; }

      const d = Object.fromEntries(new FormData(form).entries());
      btnCreate.disabled = true;

      const serviceType = (svcCategory.value === 'holiday') ? 'holiday' : 'cleaning';
      const {
        price, teamHours, teardownPrice, n, per, summary, windowLbl, holiday
      } = lastPreview;

      const startDate = d.date ? new Date(d.date + 'T' + (d.start || '09:00') + ':00') : null;

      const publicJob = {
        serviceType,
        status: "open",
        area: d.area || d.city || "",
        zip: d.zip || "",
        whenDate: d.date || "",
        whenStart: d.start || "",
        whenEnd: d.end || "",
        whenWindow: windowLbl || "",
        whenAt: startDate ? Timestamp.fromDate(startDate) : serverTimestamp(),
        summary: holiday ? "Holiday (indoor) install" : (summary || "Cleaning"),
        estHoursTeam: Number(teamHours || 0),
        contractorsNeeded: Math.max(1, Number(d.contractorsNeeded||1)),
        contractorPayEach: per ? per[0] : null,
        flatRate: Number(price || 0), // client-facing estimate for reference
        createdAt: serverTimestamp()
      };
      if (publicJob.contractorPayEach == null) delete publicJob.contractorPayEach;

      try {
        // 1) Create job doc
        const ref = await addDoc(collection(db, 'jobs'), publicJob);

        // 2) Create slots with per-contractor pay
        const need = Math.max(1, Number(d.contractorsNeeded||1));
        for (let i=0; i<need; i++){
          await setDoc(doc(db, 'jobs', ref.id, 'slots', `slot_${i+1}`), {
            slotNumber: i+1,
            status: 'open',
            contractorId: '',
            pay: per ? per[i] : null
          });
        }

        // 3) Private PII doc
        await setDoc(doc(db, 'jobs', ref.id, 'private', 'pii'), {
          name: d.name, email: d.email, phone: d.phone,
          address: `${d.street}, ${d.city}, ${d.state} ${d.zip}`,
          clientPrice: Number(price||0),
          notes: (d.notes||"")
        });

        // 4) Optional: email Formspree trail (same endpoint)
        try {
          const fd = new FormData();
          fd.append('_subject', holiday ? 'Manual Intake (Admin) — Holiday' : 'Manual Intake (Admin) — Cleaning');
          fd.append('service_type', serviceType);
          fd.append('client_name', d.name||'');
          fd.append('client_email', d.email||'');
          fd.append('client_phone', d.phone||'');
          fd.append('client_address', `${d.street}, ${d.city}, ${d.state} ${d.zip}`);
          fd.append('public_area', publicJob.area);
          fd.append('public_zip', publicJob.zip);
          fd.append('window', publicJob.whenWindow || '');
          fd.append('estimate_client_total', USD(price||0));
          if (holiday && teardownPrice) fd.append('estimate_teardown', USD(teardownPrice));
          fd.append('contractors_needed', String(need));
          if (per) fd.append('contractor_pay_each', per.join(', '));
          fd.append('job_public_id', ref.id);
          await fetch('https://formspree.io/f/mzzaogbv', { method:'POST', body: fd, headers:{'Accept':'application/json'} });
        } catch(_) {}

        statusEl.innerHTML = `<span class="ok">Job created.</span> <a href="admin.html">Admin</a> · <a href="contractor.html">Contractor board</a>`;
        calcCard.style.display = 'none';
        lastPreview = null;
      } catch (e) {
        console.warn(e);
        statusEl.innerHTML = `<span class="err">Couldn’t create job (permissions or network?).</span>`;
      } finally {
        btnCreate.disabled = false;
      }
    });
  </script>
</body>
</html>

