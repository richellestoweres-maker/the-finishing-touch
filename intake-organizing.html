<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizing Intake ‚Äì The Finishing Touch</title>

  <!-- Fonts + Site CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@400;600&family=Allura&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <!-- Page-only helpers -->
  <style>
    body{background:#fbf8f4}
    .intake-wrap{width:min(920px,92%);margin:28px auto 60px;background:#fff;padding:28px 24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .intake-title{text-align:center;font-family:"Playfair Display",serif;margin:6px 0 2px}
    .intake-script{text-align:center;font-family:"Allura",cursive;font-size:2rem;margin:0 0 12px;color:#524a46}
    .intake-note{max-width:760px;margin:0 auto 18px;text-align:center;opacity:.9}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-1{display:grid;gap:14px}
    .fieldset{border-top:1px solid #e8ddd1;margin-top:16px;padding-top:16px}
    .submit-row{text-align:center;margin-top:16px}

    /* Dropdown (light) */
    .quote-dropdown{position:relative;display:inline-block}
    .quote-button, .btn.btn-solid{cursor:pointer}
    .quote-menu{
      position:absolute; right:0; top:calc(100% + 6px);
      background:#fff; border:1px solid #e8ddd1; border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:8px; min-width:220px; display:none; z-index:50;
    }
    .quote-menu a{display:block; padding:10px 12px; border-radius:8px; color:#2a2624; text-decoration:none}
    .quote-menu a:hover{background:#f3ece6}
    .quote-dropdown.open .quote-menu{display:block}

    /* Back helper */
    .mini-bar{width:min(920px,92%);margin:12px auto 0;text-align:center}

    /* Hint */
    .hint{font-size:.95rem; opacity:.9}
  </style>
</head>
<body>
  <!-- Header (PORTAL-first nav) -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a href="client.html" class="brand-link">
          <span class="vase-logo" aria-hidden="true"></span>
          <span class="brand-name">The Finishing Touch</span>
        </a>
      </div>
      <nav class="main-nav">
        <a href="client.html">Client Portal</a>
        <div class="quote-dropdown" id="quoteDropdown">
          <button class="btn btn-solid" id="quoteBtn" aria-expanded="false" aria-controls="quoteMenu">
            Get Your Quote ‚ñæ
          </button>
          <div class="quote-menu" id="quoteMenu" role="menu" aria-hidden="true">
            <a role="menuitem" href="intake-cleaning.html">Cleaning</a>
            <a role="menuitem" href="intake-organizing.html">Organizing</a>
            <a role="menuitem" href="intake-decor.html">Interior Decorating</a>
            <a role="menuitem" href="intake-holiday.html">Holiday Decorating (Indoor)</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Back to portal -->
  <div class="mini-bar">
    <a class="btn btn-outline" href="client.html">‚Üê Back to Client Portal</a>
  </div>

  <main class="intake-wrap">
    <h1 class="intake-title">The Finishing Touch</h1>
    <div class="intake-script">Organizing Intake Form</div>
    <p class="intake-note">
      Complete this brief intake so we can review your project and follow up with a ballpark range and recommended approach.
      Uploading photos/video (optional) helps us quote accurately.
    </p>

    <!-- JS-off fallback goes straight to Formspree -->
    <form id="intakeFormOrganizing" class="grid-1" method="POST" action="https://formspree.io/f/mzzaogbv" novalidate>
      <input type="hidden" name="_subject" value="New Organizing Intake ¬∑ The Finishing Touch" />
      <input type="hidden" name="page" value="intake-organizing.html" />

      <!-- Contact -->
      <div class="grid-2">
        <label>Full Name<input name="name" autocomplete="name" required></label>
        <label>Email<input name="email" type="email" autocomplete="email" required></label>
        <label>Service Address<input name="address" autocomplete="street-address"></label>
        <label>Phone<input name="phone" type="tel" autocomplete="tel"></label>
      </div>

      <!-- Scope -->
      <div class="fieldset grid-2">
        <label>Area Type
          <select name="org_area">
            <option>Closet</option>
            <option>Kitchen</option>
            <option>Pantry</option>
            <option>Bedroom</option>
            <option>Bathroom</option>
            <option>Garage</option>
            <option>Laundry Room</option>
            <option>Office</option>
            <option>Playroom</option>
            <option>Whole Home (multi-area)</option>
          </select>
        </label>
        <label>Area Size
          <select name="org_size">
            <option>Small</option>
            <option selected>Medium</option>
            <option>Large</option>
          </select>
        </label>
        <label># of Spaces (rooms/areas)
          <input name="spaces" type="number" min="1" value="1">
        </label>
        <label>Overall Complexity
          <select name="complexity">
            <option>Light</option>
            <option selected>Moderate</option>
            <option>Heavy</option>
          </select>
        </label>
      </div>

      <!-- Complexity Drivers -->
      <div class="fieldset grid-2">
        <label>Current Clutter Level
          <select name="org_clutter">
            <option>Light</option>
            <option selected>Moderate</option>
            <option>Heavy</option>
          </select>
        </label>
        <label>Decision Speed (purge/sort)
          <select name="org_decision_speed">
            <option>Fast</option>
            <option selected>Average</option>
            <option>Slow</option>
          </select>
        </label>

        <label>Estimated Items Volume
          <select name="org_volume">
            <option>Low</option>
            <option selected>Medium</option>
            <option>High</option>
          </select>
        </label>
        <label>Containers Needed (bins/labels)
          <select name="org_containers">
            <option selected>None</option>
            <option>Some (up to 10)</option>
            <option>Many (10+)</option>
          </select>
        </label>

        <label>Notes / Focus Areas
          <input name="notes" placeholder="e.g., zones for kids, seasonal storage">
        </label>
        <label>Add-ons (type keywords: bins, labels, bins/labels)
          <input name="addons" placeholder="e.g., bins/labels">
        </label>
      </div>

      <!-- Media Uploads (optional) -->
      <div class="fieldset grid-1">
        <p class="hint" style="margin:0 0 8px;">
          <strong>Photos/Video (optional):</strong> Upload 3‚Äì10 photos (and an optional short video) to help us quote accurately.
          Best shots: wide view of the space, inside cabinets/closet, and the main problem zones.
        </p>

        <label>Upload Photos (optional)
          <input name="media_photos" id="mediaPhotos" type="file" accept="image/*" multiple>
        </label>

        <label>Upload Video (optional, short)
          <input name="media_video" id="mediaVideo" type="file" accept="video/*">
        </label>

        <p class="hint" id="uploadStatus" style="margin:6px 0 0;"></p>
      </div>

      <!-- Preferences -->
      <div class="fieldset grid-2">
        <label>Preferred Days / Times
          <input name="availability" placeholder="e.g., Tue/Thu mornings">
        </label>
        <label>Payment Preference
          <select name="pay">
            <option>Zelle</option><option>Venmo</option><option>Cash App</option><option>Cash</option>
          </select>
        </label>
      </div>

      <!-- Donation note -->
      <div class="fieldset grid-1" role="note" aria-live="polite">
        <p class="hint" style="margin:0;">
          <strong>Donations &amp; Discards:</strong> Clients are responsible for removing donations and discards. We can bag/box and stage for your preferred pickup/drop-off.
        </p>
      </div>

      <!-- Consents -->
      <fieldset class="fieldset grid-1" aria-labelledby="consentLegend">
        <legend id="consentLegend" style="font-weight:700;">Consents</legend>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_sms_email" value="Yes" required>
          <span>Okay to contact me by email/SMS with scheduling and project updates.</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_photos_doc" value="Yes" required>
          <span>I consent to before/after photos for job documentation (internal only).</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_photos_marketing" value="Yes">
          <span>I also consent to selected photos being used for marketing (website/social).</span>
        </label>

        <label style="display:flex;gap:.6rem;align-items:flex-start;">
          <input type="checkbox" name="consent_terms" value="Yes" required>
          <span>I agree to the service terms (scheduling, access, cancellation, and safety). <a href="terms.html#client-terms" target="_blank" rel="noopener">Read terms</a>.</span>
        </label>
      </fieldset>

      <!-- Submit -->
      <div class="submit-row">
        <button class="btn btn-solid" type="submit" id="orgSubmitBtn">Submit Organizing Intake</button>
        <p id="emailStatusOrganizing" class="hint"></p>
      </div>
    </form>
  </main>

  <!-- Dropdown behavior -->
  <script>
    (function(){
      const dd  = document.getElementById('quoteDropdown');
      const btn = document.getElementById('quoteBtn');
      const menu= document.getElementById('quoteMenu');
      if (!dd || !btn || !menu) return;
      function toggle(open){
        dd.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
        menu.setAttribute('aria-hidden', String(!open));
      }
      btn.addEventListener('click', (e)=>{ e.preventDefault(); toggle(!dd.classList.contains('open')); });
      document.addEventListener('click', (e)=>{ if (!dd.contains(e.target)) toggle(false); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') toggle(false); });
    })();
  </script>

  <!-- Your site JS (keep if other pages use it; this page no longer relies on public pricing) -->
  <script src="script.js?v=7" defer></script>

  <!-- Firebase uploads + backend-only internal estimate -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

    // ‚úÖ PASTE YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // storageBucket: "...",
      // appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const functions = getFunctions(app);

    // Cloud Function name (you create this in Firebase Functions)
    const submitOrganizingIntake = httpsCallable(functions, "submitOrganizingIntake");

    async function uploadMedia(intakeId, photoFiles, videoFile) {
      const statusEl = document.getElementById("uploadStatus");
      const photoUrls = [];
      let videoUrl = "";

      const total = (photoFiles?.length || 0) + (videoFile ? 1 : 0);
      let done = 0;

      const update = () => {
        if (!statusEl) return;
        statusEl.textContent = total ? `Uploading media‚Ä¶ ${done}/${total}` : "";
      };

      update();

      for (const file of (photoFiles || [])) {
        const path = `organizing-intakes/${intakeId}/photos/${Date.now()}-${file.name}`;
        const fileRef = ref(storage, path);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        photoUrls.push(url);
        done++;
        update();
      }

      if (videoFile) {
        const path = `organizing-intakes/${intakeId}/video/${Date.now()}-${videoFile.name}`;
        const fileRef = ref(storage, path);
        await uploadBytes(fileRef, videoFile);
        videoUrl = await getDownloadURL(fileRef);
        done++;
        update();
      }

      if (statusEl) statusEl.textContent = total ? "Media uploaded ‚úî" : "";
      return { photoUrls, videoUrl };
    }

    // expose to window for the non-module chat + page scripts
    window.__FTT_ORG = { submitOrganizingIntake, uploadMedia };
  </script>

  <!-- Internal pricing + Formspree submit (NO client pricing, NO booking) -->
  <script>
    (function(){
      // Boutique internal defaults
      const HOURLY_PER_ORG = 95;
      const MIN_HOURS_PER_ORG = 3;
      const SMALL_SPACE_START = 250;
      const SMALL_SPACE_CAP = 450; // if "small space" estimate exceeds this, auto-bump to hourly model

      function roundTo(n, step){ return Math.round(n/step)*step; }
      function normalize(v){ return (v||"").toString().trim(); }
      function isWholeHome(area){ return /whole home/i.test(area||""); }

      function buildPrepNotes(data){
        const notes = [];
        const area = normalize(data.org_area);
        const clutter = normalize(data.org_clutter);
        const volume = normalize(data.org_volume);
        const decision = normalize(data.org_decision_speed);
        const containers = normalize(data.org_containers);
        const addons = normalize(data.addons).toLowerCase();

        if (clutter === "Heavy") notes.push("Bring extra donation bags/boxes; expect slower sorting.");
        if (volume === "High") notes.push("High item volume ‚Äî plan for staging space + categories.");
        if (decision === "Slow") notes.push("Decision support likely ‚Äî build in buffer time.");
        if (containers !== "None") notes.push("Containers/labels likely ‚Äî confirm sourcing vs recommendations.");
        if (/bin|label|container/.test(addons)) notes.push("Client requested bins/labels ‚Äî clarify budget + sourcing.");
        if (isWholeHome(area)) notes.push("Whole-home resets often work best phased by priority zones.");
        return notes;
      }

      function computeHourlyModel(data, overrides){
        const area = normalize(data.org_area);
        const size = overrides?.forceSize || normalize(data.org_size) || "Medium";
        const spaces = overrides?.forceSpaces || Math.max(1, parseInt(data.spaces || "1", 10) || 1);

        const complexity = normalize(data.complexity) || "Moderate";
        const clutter = normalize(data.org_clutter) || "Moderate";
        const volume = normalize(data.org_volume) || "Medium";
        const decision = normalize(data.org_decision_speed) || "Average";

        const basePerSpace = (size === "Small") ? 1.5 : (size === "Large") ? 2.5 : 2.0;

        let mult = 1.0;
        if (complexity === "Heavy") mult *= 1.25;
        if (clutter === "Heavy") mult *= 1.25;
        if (volume === "High") mult *= 1.20;
        if (decision === "Slow") mult *= 1.15;

        let totalLaborHours = spaces * basePerSpace * mult;

        let organizers = 1;
        if (spaces >= 3 || clutter === "Heavy" || complexity === "Heavy" || isWholeHome(area)) organizers = 2;
        if (spaces >= 6 && (clutter === "Heavy" || complexity === "Heavy" || isWholeHome(area))) organizers = 3;

        let hoursPerOrg = totalLaborHours / organizers;
        hoursPerOrg = Math.max(MIN_HOURS_PER_ORG, Math.ceil(hoursPerOrg * 2) / 2);

        const low = roundTo(organizers * hoursPerOrg * HOURLY_PER_ORG * 0.95, 25);
        const high = roundTo(organizers * hoursPerOrg * HOURLY_PER_ORG * 1.15, 25);

        const phaseSuggested = (isWholeHome(area) || spaces >= 5 || clutter === "Heavy" || complexity === "Heavy");

        return {
          category: "Larger Project / Whole-Home (Hourly)",
          model: "hourly",
          organizers,
          hoursPerOrganizer: hoursPerOrg,
          hourlyPerOrganizer: HOURLY_PER_ORG,
          rangeLow: low,
          rangeHigh: high,
          phaseSuggested,
          prepNotes: buildPrepNotes(data),
        };
      }

      function computeInternalRecommendation(data){
        const area = normalize(data.org_area);
        const size = normalize(data.org_size) || "Medium";
        const spaces = Math.max(1, parseInt(data.spaces || "1", 10) || 1);

        const complexity = normalize(data.complexity) || "Moderate";
        const clutter = normalize(data.org_clutter) || "Moderate";
        const volume = normalize(data.org_volume) || "Medium";
        const decision = normalize(data.org_decision_speed) || "Average";
        const containers = normalize(data.org_containers) || "None";
        const addons = normalize(data.addons).toLowerCase();

        const smallAreaList = ["pantry","linen","fridge","freezer","entry","coat","closet","laundry"];
        const looksSmall = smallAreaList.some(k => area.toLowerCase().includes(k));
        const smallCandidate = looksSmall && spaces === 1 && !isWholeHome(area);

        const wantsBins = /bin|bins|label|labels|container|containers/.test(addons);

        if (smallCandidate) {
          let price = SMALL_SPACE_START;

          if (size === "Small") price += 0;
          if (size === "Medium") price += 25;
          if (size === "Large") price += 60;

          if (complexity === "Light") price += 0;
          if (complexity === "Moderate") price += 20;
          if (complexity === "Heavy") price += 55;

          if (clutter === "Light") price += 0;
          if (clutter === "Moderate") price += 25;
          if (clutter === "Heavy") price += 70;

          if (volume === "Low") price += 0;
          if (volume === "Medium") price += 15;
          if (volume === "High") price += 45;

          if (decision === "Fast") price += 0;
          if (decision === "Average") price += 10;
          if (decision === "Slow") price += 35;

          if (containers === "Some (up to 10)") price += 25;
          if (containers === "Many (10+)") price += 50;

          if (wantsBins) price += 15;

          let hours = 3;
          if (clutter === "Heavy" || volume === "High" || complexity === "Heavy") hours = 4;
          if (size === "Large" && (clutter === "Heavy" || volume === "High")) hours = 4.5;

          if (price > SMALL_SPACE_CAP) {
            return computeHourlyModel(data, { forceSpaces: spaces, forceSize: size });
          }

          const low = roundTo(price * 0.95, 10);
          const high = roundTo(price * 1.10, 10);

          return {
            category: "Small-Space Package",
            model: "small_space",
            organizers: 1,
            hoursPerOrganizer: hours,
            hourlyPerOrganizer: HOURLY_PER_ORG,
            rangeLow: low,
            rangeHigh: high,
            phaseSuggested: false,
            prepNotes: buildPrepNotes(data),
          };
        }

        return computeHourlyModel(data);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('intakeFormOrganizing');
        if (!form) return;

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          e.stopImmediatePropagation();

          const statusEl = document.getElementById('emailStatusOrganizing');
          const submitBtn = document.getElementById('orgSubmitBtn');
          if (statusEl) statusEl.textContent = "";
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = "Submitting‚Ä¶"; }

          const fd = new FormData(form);

          // Extract file inputs (optional)
          const photoFiles = document.getElementById("mediaPhotos")?.files || [];
          const videoFile  = document.getElementById("mediaVideo")?.files?.[0] || null;

          // Convert non-file fields to object
          const data = {};
          fd.forEach((v, k) => {
            if (k === "media_photos" || k === "media_video") return;
            data[k] = v;
          });

          const intakeId = `org_${Date.now()}_${Math.random().toString(16).slice(2)}`;

          // Internal recommendation from intake alone (works even w/o photos)
          const rec = computeInternalRecommendation(data);

          // Upload media if provided
          let media = { photoUrls: [], videoUrl: "" };
          try {
            if (window.__FTT_ORG?.uploadMedia && (photoFiles.length || videoFile)) {
              media = await window.__FTT_ORG.uploadMedia(intakeId, Array.from(photoFiles), videoFile);
            }
          } catch (err) {
            console.warn("Media upload failed:", err);
          }

          // Save to backend (private record)
          try {
            if (window.__FTT_ORG?.submitOrganizingIntake) {
              await window.__FTT_ORG.submitOrganizingIntake({
                intakeId,
                customerName: data.name || "",
                email: data.email || "",
                phone: data.phone || "",
                address: data.address || "",
                org_area: data.org_area || "",
                org_size: data.org_size || "",
                spaces: parseInt(data.spaces || "1", 10) || 1,
                complexity: data.complexity || "",
                org_clutter: data.org_clutter || "",
                org_decision_speed: data.org_decision_speed || "",
                org_volume: data.org_volume || "",
                org_containers: data.org_containers || "",
                addons: data.addons || "",
                notes: data.notes || "",
                availability: data.availability || "",
                pay: data.pay || "",
                photoUrls: media.photoUrls || [],
                videoUrl: media.videoUrl || "",
                internalRecommendation: rec
              });
            }
          } catch (err) {
            console.warn("Backend submit failed:", err);
          }

          // Append internal-only fields to your Formspree email
          fd.append("intake_id", intakeId);
          fd.append("INTERNAL_category", rec.category);
          fd.append("INTERNAL_model", rec.model);
          fd.append("INTERNAL_organizers", String(rec.organizers));
          fd.append("INTERNAL_hours_per_organizer", String(rec.hoursPerOrganizer));
          fd.append("INTERNAL_hourly_per_organizer", "$" + String(rec.hourlyPerOrganizer));
          fd.append("INTERNAL_ballpark_range", `$${rec.rangeLow} ‚Äì $${rec.rangeHigh}`);
          fd.append("INTERNAL_phase_suggested", rec.phaseSuggested ? "Yes" : "No");
          fd.append("INTERNAL_prep_notes", (rec.prepNotes || []).join(" | "));
          fd.append("photo_urls", (media.photoUrls || []).join("\n"));
          fd.append("video_url", media.videoUrl || "");

          // Send to Formspree (AJAX)
          try{
            const resp = await fetch(form.action, {
              method: 'POST',
              headers: { 'Accept': 'application/json' },
              body: fd
            });

            if (resp.ok){
              if (statusEl) statusEl.textContent =
                "Thanks! We‚Äôve received your intake. We‚Äôll review your details and follow up with a ballpark range and recommended approach.";
              form.reset();
              const up = document.getElementById("uploadStatus");
              if (up) up.textContent = "";
            } else {
              if (statusEl) statusEl.textContent =
                "We received your intake, but couldn‚Äôt reach our inbox right now. If needed, please email us and reference your submission.";
            }
          }catch(err){
            console.warn(err);
            if (statusEl) statusEl.textContent =
              "We received your intake, but your connection seems unstable. If you don‚Äôt hear back soon, please email us directly.";
          } finally {
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = "Submit Organizing Intake"; }
          }
        }, true);
      });
    })();
  </script>

  <!-- Chat (guarded; page-aware) -->
  <div id="ftt-chat-launcher" aria-label="Open chat" role="button">üí¨</div>

  <div id="ftt-chat" aria-live="polite" aria-label="Chat window" hidden>
    <div class="ftt-chat-header">
      <div>
        <div class="ftt-title">The Finishing Touch</div>
        <div class="ftt-subtitle">AI Concierge ‚Ä¢ human on request</div>
      </div>
      <button class="ftt-close" aria-label="Close chat">√ó</button>
    </div>

    <div id="ftt-thread" class="ftt-thread"></div>

    <form id="ftt-inputbar" class="ftt-inputbar" autocomplete="off">
      <input id="ftt-input" name="message" type="text" placeholder="Ask about pricing, availability, services‚Ä¶" aria-label="Type your message" required />
      <button class="ftt-send" type="submit">Send</button>
    </form>

    <div class="ftt-quick">
      <button data-q="pricing">Pricing</button>
      <button data-q="availability">Availability</button>
      <button data-q="services">Services</button>
      <button data-q="book">Book now</button>
      <button data-q="human">Talk to a person</button>
      <button data-q="help">Help me choose</button>
    </div>
  </div>

  <script>
    (function(){
      if (window.__FTT_CHAT_READY__) return;
      window.__FTT_CHAT_READY__ = true;

      const FTT_CFG = {
        timezone: "America/Chicago",
        intakeAnchor: "intake-organizing.html",
        bookUrl: "https://book.squareup.com/appointments/kbcbv6uu1d7qd7/location/L2P303Y0SXTD9",
        email: "contact.thefinishingtouch.tx@gmail.com",
        messengerDeepLink: "https://m.me/thefinishingtouch.tx",
        hours: { days:[1,2,3,4,5], open:"09:00", close:"17:00" },
      };
      const el = {
        launcher: document.getElementById("ftt-chat-launcher"),
        panel: document.getElementById("ftt-chat"),
        thread: document.getElementById("ftt-thread"),
      };
      function addMsg(html, who="bot"){
        const b=document.createElement("div");
        b.className=`ftt-bubble ${who}`; b.innerHTML=html;
        el.thread.appendChild(b); el.thread.scrollTop=el.thread.scrollHeight;
      }
      function greet(){ addMsg("Hi! I‚Äôm your AI concierge. Ask me about pricing, availability, or services. Say ‚Äúhuman‚Äù anytime.","bot"); }
      function detectIntent(text){
        const t=text.toLowerCase();
        if (/(human|person|agent|representative|someone|call|talk to)/.test(t)) return "human";
        if (/(price|pricing|cost|rate|how much)/.test(t)) return "pricing";
        if (/(avail|slot|appointment|when|schedule|open)/.test(t)) return "availability";
        if (/(service|organize|staging|what do you do)/.test(t)) return "services";
        if (/(book|booking|schedule now)/.test(t)) return "book";
        if (/(which|help choose|recommend|not sure|what should i (pick|choose)|suggest)/.test(t)) return "recommend";
        return "fallback";
      }
      function answer(intent){
        const intakeLink = `<a href="${FTT_CFG.intakeAnchor}">Start Intake</a>`;
        switch(intent){
          case "pricing":
            return [
              "Organizing is priced based on scope and time.",
              "Small-space projects start around $250; larger projects are billed hourly per organizer with a three-hour minimum.",
              "Submit the intake and we‚Äôll follow up with a tailored ballpark range. " + intakeLink + "."
            ].join("<br>");
          case "availability":
            return ["After you submit the intake, we‚Äôll follow up with scheduling options.", "Start here: " + intakeLink + "."].join("<br>");
          case "services":
            return [
              "We declutter, sort, and set up practical systems (closets, kitchens, pantries, garages, kids‚Äô spaces, offices).",
              "We can label and recommend or source containers if desired.",
              "Want the best next step? " + intakeLink + "."
            ].join("<br>");
          case "book":
            return "We don‚Äôt use instant booking for organizing projects ‚Äî submit the intake and we‚Äôll follow up with the best approach and scheduling options. " + intakeLink + ".";
          case "human":
            return `Absolutely. Tap <a href="${FTT_CFG.messengerDeepLink}" target="_blank" rel="noopener">Message us on Facebook</a> or email <a href="mailto:${FTT_CFG.email}">${FTT_CFG.email}</a>.`;
          case "recommend":
            return [
              "<strong>Happy to help you choose!</strong>",
              "Small-space (starts around $250): pantry, linen, fridge/freezer, entry closet",
              "Larger projects: kitchens, playrooms, primary suites, garages, multi-space resets (hourly with 3-hour minimum)",
              "Start here and we‚Äôll recommend the best approach: " + intakeLink + "."
            ].join("<br>");
          default:
            return ["I can help with pricing, availability, and services.", "Try ‚Äúwhat‚Äôs your pricing?‚Äù or ‚Äúwhat do you organize?‚Äù", "Say ‚Äúhuman‚Äù any time to talk to a person."].join("<br>");
        }
      }
      function init(){
        const closeBtn = document.querySelector(".ftt-close");
        const input = document.getElementById("ftt-input");
        const form  = document.getElementById("ftt-inputbar");
        const quick = document.querySelector(".ftt-quick");

        el.launcher.addEventListener("click", () => {
          el.panel.hidden = false;
          if (!el.thread.dataset.greeted) { greet(); el.thread.dataset.greeted = "1"; }
          input.focus();
        });
        closeBtn.addEventListener("click", () => { el.panel.hidden = true; });
        form.addEventListener("submit", (e)=>{
          e.preventDefault();
          const text = input.value.trim(); if (!text) return;
          const bubble = document.createElement("div"); bubble.className="ftt-bubble me"; bubble.textContent=text; el.thread.appendChild(bubble);
          input.value=""; el.thread.scrollTop=el.thread.scrollHeight;
          setTimeout(()=> { addMsg(answer(detectIntent(text)),"bot"); }, 200);
        });
        quick.addEventListener("click", (e)=>{
          if (e.target.matches("button[data-q]")){
            const map={pricing:"pricing",availability:"availability",services:"services",book:"book",human:"human",help:"recommend"};
            const intent = map[e.target.getAttribute("data-q")] || "fallback";
            addMsg(e.target.textContent,"me"); setTimeout(()=> addMsg(answer(intent),"bot"),200);
          }
        });
      }
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>

  <!-- Optional shared chat guard -->
  <script src="ftt-chat.js" defer></script>
</body>
</html>

